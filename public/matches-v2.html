<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>皇冠赛事中心</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 10px; font-size: 12px; }
        .header { background: white; padding: 12px 15px; border-radius: 4px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .header h1 { font-size: 16px; margin-bottom: 10px; }
        .tabs { display: flex; gap: 6px; }
        .tab { padding: 6px 14px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .tab.active { background: #1890ff; color: white; }
        .match-card { background: white; margin-bottom: 8px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        .match-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 10px 15px; background: #e6f7ff; border-bottom: 1px solid #d9d9d9; }
        .home-team { text-align: left; font-size: 14px; font-weight: 500; }
        .match-center { text-align: center; padding: 0 20px; }
        .league { font-size: 11px; color: #1890ff; margin-bottom: 3px; }
        .score { font-size: 16px; font-weight: bold; color: #ff4d4f; }
        .match-status { font-size: 11px; color: #666; margin-top: 3px; }
        .away-team { text-align: right; font-size: 14px; font-weight: 500; }
        .markets { display: grid; grid-template-columns: repeat(6, 1fr); }
        .market { border-right: 1px solid #f0f0f0; padding: 8px 6px; }
        .market:last-child { border-right: none; }
        .market-title { font-size: 11px; color: #666; margin-bottom: 6px; text-align: center; font-weight: 500; }
        .market-moneyline { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .market-handicap, .market-overunder { display: flex; flex-direction: column; gap: 4px; }
        .market-row { display: grid; grid-template-columns: auto 1fr 1fr; gap: 4px; align-items: center; }
        .hdp-label { font-size: 11px; color: #666; white-space: nowrap; padding-right: 4px; min-width: 35px; }
        .odds-btn { background: #fafafa; border: 1px solid #e0e0e0; border-radius: 3px; padding: 6px 4px; text-align: center; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 500; }
        .odds-btn:hover { border-color: #1890ff; background: #e6f7ff; color: #1890ff; }
        .odds-btn.disabled { opacity: 0.3; cursor: not-allowed; }
        .empty-cell { text-align: center; color: #ccc; font-size: 14px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>皇冠赛事中心</h1>
        <div class="tabs">
            <button class="tab active" data-type="live">滚球 (<span id="live-count">0</span>)</button>
            <button class="tab" data-type="today">今日 (<span id="today-count">0</span>)</button>
            <button class="tab" data-type="early">早盘 (<span id="early-count">0</span>)</button>
        </div>
    </div>

    <div id="matches-container"></div>
    <script>
        let ws = null, reconnectTimer = null, currentType = 'live';
        const matchesData = { live: [], today: [], early: [] };
        const SUBSCRIBE_TYPES = ['live', 'today', 'early'];
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_URL = `${protocol}//${window.location.host}/ws`;
        const AUTH_TOKEN = 'latiaolatiaozhurenzhuren';
        let isAuthenticated = false;
        const isEmptyValue = (value) => value === null || value === undefined || value === '';
        const formatOdd = (value) => {
            if (isEmptyValue(value)) return '-';
            const num = Number(value);
            return Number.isFinite(num) ? num.toFixed(2) : '-';
        };
        const formatLine = (value, showSign = false) => {
            if (isEmptyValue(value)) return '-';
            const num = Number(value);
            if (!Number.isFinite(num)) return '-';
            const rounded = Math.abs(num % 1) < 1e-6 ? num.toFixed(0) : num.toFixed(2);
            const display = rounded === '-0' ? '0' : rounded;
            if (showSign && num > 0) {
                return `+${display}`;
            }
            if (showSign && num < 0 && !display.startsWith('-')) {
                return `-${display}`;
            }
            return display;
        };

        function init() {
            setupTabs();
            connectWebSocket();
        }

        function connectWebSocket() {
            clearTimeout(reconnectTimer);
            isAuthenticated = false;

            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocket连接成功');
                sendAuth();
            };

            ws.onmessage = (event) => {
                try {
                    handleMessage(JSON.parse(event.data));
                } catch (error) {
                    console.error('解析消息失败:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket错误:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket连接关闭，3秒后重连...');
                reconnectTimer = setTimeout(connectWebSocket, 3000);
            };
        }

        function sendAuth() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: 'auth', data: { token: AUTH_TOKEN } }));
        }

        function handleMessage(message) {
            switch (message.type) {
                case 'heartbeat':
                    handleHeartbeat(message.data);
                    break;
                case 'error':
                    handleServerError(message.data);
                    break;
                case 'full_data':
                    handleFullData(message.data);
                    break;
                case 'match_add':
                    handleMatchAdd(message.data);
                    break;
                case 'match_update':
                case 'odds_update':
                case 'score_update':
                    handleMatchUpdate(message.data);
                    break;
                case 'match_remove':
                    handleMatchRemove(message.data);
                    break;
                default:
                    break;
            }
        }

        function handleMatchAdd(payload = {}) {
            const showType = payload.showType;
            const match = payload.match;
            if (!showType || !match || !match.gid) return;
            const list = matchesData[showType] || [];
            const index = list.findIndex(m => m.gid === match.gid);
            if (index >= 0) {
                list[index] = match;
            } else {
                list.push(match);
            }
            matchesData[showType] = list;
            updateCount(showType, list.length);
            if (showType === currentType) renderMatches();
        }

        function handleMatchUpdate(payload = {}) {
            const showType = payload.showType;
            const match = payload.match;
            const gid = (match && match.gid) || payload.gid;
            if (!showType || !gid) return;
            const list = matchesData[showType] || [];
            const index = list.findIndex(m => m.gid === gid);
            if (index >= 0) {
                list[index] = match ? { ...list[index], ...match } : list[index];
            } else if (match) {
                list.push(match);
            }
            matchesData[showType] = list;
            updateCount(showType, list.length);
            if (showType === currentType) renderMatches();
        }

        function handleMatchRemove(payload = {}) {
            const showType = payload.showType;
            const gid = payload.gid;
            if (!showType || !gid) return;
            const list = matchesData[showType] || [];
            const next = list.filter(m => m.gid !== gid);
            matchesData[showType] = next;
            updateCount(showType, next.length);
            if (showType === currentType) renderMatches();
        }

        function handleHeartbeat(data = {}) {
            if (data.message === '认证成功' && !isAuthenticated) {
                isAuthenticated = true;
                subscribeAll();
            }
        }

        function handleServerError(data = {}) {
            const errorMsg = (data?.error || '').toString();
            console.warn('服务器错误:', errorMsg);
        }

        function handleFullData(payload = {}) {
            const showType = payload.showType;
            if (!showType) return;
            matchesData[showType] = payload.matches || [];
            updateCount(showType, matchesData[showType].length);
            if (showType === currentType) renderMatches();
        }

        function subscribeAll() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: 'subscribe',
                data: { showTypes: SUBSCRIBE_TYPES }
            }));
        }

        function updateCount(type, count) { const countEl = document.getElementById(`${type}-count`); if (countEl) countEl.textContent = count; }

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentType = tab.dataset.type;
                    renderMatches();
                });
            });
        }
        function renderMatches() {
            const container = document.getElementById('matches-container');
            const matches = matchesData[currentType] || [];
            if (matches.length === 0) { container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">暂无赛事</div>'; return; }
            container.innerHTML = matches.map(match => renderMatch(match)).join('');
        }
        function renderMatch(match) {
            return `<div class="match-card">
                <div class="match-header">
                    <div class="home-team">${match.home || '主队'}</div>
                    <div class="match-center">
                        <div class="league">${match.league || '联赛'}${match.gid ? ' [' + match.gid + ']' : ''}</div>
                        <div class="score">(${match.home_score || 0}-${match.away_score || 0})</div>
                        <div class="match-status">${match.match_time || '未开赛'}</div>
                    </div>
                    <div class="away-team">${match.away || '客队'}</div>
                </div>
                <div class="markets">
                    ${renderMoneyline(match.markets)}
                    ${renderHandicap(match.markets?.full, '让球(1/2)')}
                    ${renderOverUnder(match.markets?.full, '大小(O/U)')}
                    ${renderMoneylineHalf(match.markets)}
                    ${renderHandicap(match.markets?.half, '让球(半场)')}
                    ${renderOverUnder(match.markets?.half, '大小(O/U半)')}
                </div>
            </div>`;
        }
        function renderMoneyline(markets) {
            if (!markets?.moneyline) return '<div class="market"><div class="market-title">独赢(1/2/X)</div><div class="empty-cell">-</div></div>';
            const m = markets.moneyline;
            return `<div class="market"><div class="market-title">独赢(1/2/X)</div><div class="market-moneyline">
                <div class="odds-btn ${isEmptyValue(m.home) ? 'disabled' : ''}">${formatOdd(m.home)}</div>
                <div class="odds-btn ${isEmptyValue(m.draw) ? 'disabled' : ''}">${formatOdd(m.draw)}</div>
                <div class="odds-btn ${isEmptyValue(m.away) ? 'disabled' : ''}">${formatOdd(m.away)}</div>
            </div></div>`;
        }
        function renderHandicap(market, title) {
            const lines = Array.isArray(market?.handicapLines) ? market.handicapLines.filter(Boolean) : [];
            if (!lines.length) return `<div class="market"><div class="market-title">${title}</div><div class="empty-cell">-</div></div>`;
            const rows = lines.map(line => `<div class="market-row">
                <div class="hdp-label">${formatLine(line.hdp, true)}</div>
                <div class="odds-btn ${isEmptyValue(line.home) ? 'disabled' : ''}">${formatOdd(line.home)}</div>
                <div class="odds-btn ${isEmptyValue(line.away) ? 'disabled' : ''}">${formatOdd(line.away)}</div>
            </div>`).join('');
            return `<div class="market"><div class="market-title">${title}</div><div class="market-handicap">${rows}</div></div>`;
        }
        function renderOverUnder(market, title) {
            const lines = Array.isArray(market?.overUnderLines) ? market.overUnderLines.filter(Boolean) : [];
            if (!lines.length) return `<div class="market"><div class="market-title">${title}</div><div class="empty-cell">-</div></div>`;
            const rows = lines.map(line => `<div class="market-row">
                <div class="hdp-label">${formatLine(line.hdp)}</div>
                <div class="odds-btn ${isEmptyValue(line.over) ? 'disabled' : ''}">${formatOdd(line.over)}</div>
                <div class="odds-btn ${isEmptyValue(line.under) ? 'disabled' : ''}">${formatOdd(line.under)}</div>
            </div>`).join('');
            return `<div class="market"><div class="market-title">${title}</div><div class="market-overunder">${rows}</div></div>`;
        }
        function renderMoneylineHalf(markets) {
            if (!markets?.half?.moneyline) return '<div class="market"><div class="market-title">独赢(半场)</div><div class="empty-cell">-</div></div>';
            const m = markets.half.moneyline;
            return `<div class="market"><div class="market-title">独赢(半场)</div><div class="market-moneyline">
                <div class="odds-btn ${isEmptyValue(m.home) ? 'disabled' : ''}">${formatOdd(m.home)}</div>
                <div class="odds-btn ${isEmptyValue(m.draw) ? 'disabled' : ''}">${formatOdd(m.draw)}</div>
                <div class="odds-btn ${isEmptyValue(m.away) ? 'disabled' : ''}">${formatOdd(m.away)}</div>
            </div></div>`;
        }
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>赔率数据管理系统</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #8b5cf6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1e293b;
      --dark-light: #334155;
      --gray: #64748b;
      --gray-light: #cbd5e1;
      --bg: #0f172a;
      --bg-light: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* 侧边栏 */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: var(--bg-light);
      border-right: 1px solid var(--border);
      padding: 20px 0;
      z-index: 1000;
      transition: transform 0.3s;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h1 {
      font-size: 20px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-nav {
      padding: 20px 0;
    }

    .nav-item {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: var(--text);
    }

    .nav-item.active {
      background: rgba(59, 130, 246, 0.15);
      color: var(--primary);
      border-left-color: var(--primary);
    }

    .nav-item i {
      font-size: 20px;
    }

    /* 主内容区 */
    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    /* 顶部栏 */
    .topbar {
      background: var(--bg-light);
      border-bottom: 1px solid var(--border);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      padding: 8px 15px 8px 40px;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      width: 300px;
      font-size: 14px;
    }

    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-secondary {
      background: var(--dark-light);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-icon {
      padding: 8px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 内容区域 */
    .content {
      padding: 30px;
    }

    .page-header {
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* 统计卡片 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
      opacity: 0.6;
    }

    .stat-card:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-icon.blue { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
    .stat-icon.green { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .stat-icon.purple { background: rgba(139, 92, 246, 0.2); color: var(--secondary); }
    .stat-icon.orange { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

    .stat-info h3 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-info p {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* 卡片 */
    .card {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .card-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .card-body {
      padding: 20px;
    }

    /* 标签页 */
    .tabs {
      display: flex;
      gap: 5px;
      border-bottom: 2px solid var(--border);
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* 筛选栏 */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }

    select, input[type="text"], input[type="number"] {
      padding: 8px 12px;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* 表格 */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--dark);
      position: sticky;
      top: 0;
    }

    th {
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    td {
      padding: 12px 15px;
      border-top: 1px solid var(--border);
      font-size: 14px;
    }

    tbody tr {
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    /* 徽章 */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-live {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .badge-today {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .badge-early {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
    }

    .badge-mapped {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .badge-unmapped {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    /* 赔率显示 */
    .odds-group {
      display: flex;
      gap: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .odds-value {
      padding: 4px 8px;
      background: var(--dark);
      border-radius: 4px;
      min-width: 50px;
      text-align: center;
    }

    /* 赔率单元格样式 */
    .odds-cell {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      text-align: center;
      padding: 8px 6px !important;
      background: var(--dark);
      border-right: 1px solid var(--border);
      font-weight: 500;
    }

    .odds-cell.handicap {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
      font-weight: 600;
    }

    /* 表格样式优化 */
    table thead th {
      background: var(--dark);
      font-size: 12px;
      padding: 10px 8px;
      white-space: nowrap;
    }

    table tbody td {
      padding: 10px 8px;
      font-size: 13px;
    }

    table tbody tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }



    /* 赛事卡片布局 */
    .matches-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .match-card {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .match-header {
      background: var(--dark);
      padding: 12px 15px;
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      align-items: center;
      font-size: 13px;
      color: var(--text);
      font-weight: 500;
      border-bottom: 1px solid var(--border);
      gap: 15px;
    }

    .match-header .team-home {
      text-align: left;
      font-weight: 600;
    }

    .match-header .match-info {
      text-align: center;
    }

    .match-header .team-away {
      text-align: right;
      font-weight: 600;
    }

    .match-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .match-odds-header {
      display: grid;
      grid-template-columns: repeat(6, 1fr) 80px;
      background: rgba(15, 23, 42, 0.8);
      border-bottom: 1px solid var(--border);
    }

    .match-odds-header .header-cell {
      padding: 8px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      border-right: 1px solid var(--border);
    }

    .match-odds-header .header-cell:last-child {
      border-right: none;
    }

    .match-body {
      display: grid;
      grid-template-columns: repeat(6, 1fr) 80px;
      align-items: center;
    }

    .odds-group-cell {
      padding: 0;
      border-right: 1px solid var(--border);
      display: flex;
    }

    .odds-item {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      text-align: center;
      padding: 15px 8px;
      background: rgba(15, 23, 42, 0.5);
      border-right: 1px solid var(--border);
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .odds-item:last-child {
      border-right: none;
    }

    .odds-item.handicap {
      background: rgba(59, 130, 246, 0.15);
      color: var(--primary);
      font-weight: 600;
    }

    .action-cell {
      padding: 8px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .match-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    }

    /* 操作按钮 */
    .action-btns {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
    }

    /* 模态框 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-light);
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px var(--shadow);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--dark);
      color: var(--text);
    }

    .modal-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      background: var(--dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* 分页样式 */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      padding: 15px;
      gap: 10px;
    }

    .pagination .btn {
      min-width: 70px;
    }

    .pagination .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 加载动画 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 空状态 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    /* 响应式 */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .main-content {
        margin-left: 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .search-box input {
        width: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- 侧边栏 -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1><i class="ri-dashboard-line"></i> 赔率管理</h1>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" data-page="dashboard">
        <i class="ri-dashboard-3-line"></i>
        <span>数据总览</span>
      </div>
      <div class="nav-item" data-page="thirdparty">
        <i class="ri-database-2-line"></i>
        <span>第三方赔率</span>
      </div>
      <div class="nav-item" data-page="crown">
        <i class="ri-trophy-line"></i>
        <span>皇冠赛事</span>
      </div>
      <div class="nav-item" data-page="mapping">
        <i class="ri-link-m"></i>
        <span>球队映射</span>
      </div>
      <div class="nav-item" data-page="league-mapping">
        <i class="ri-trophy-line"></i>
        <span>联赛映射</span>
      </div>
      <div class="nav-item" data-page="match-push">
        <i class="ri-send-plane-line"></i>
        <span>赛事推送</span>
      </div>
      <div class="nav-item" data-page="match-compare">
        <i class="ri-git-compare-line"></i>
        <span>赛事匹配</span>
      </div>
    </nav>
  </div>

  <!-- 主内容区 -->
  <div class="main-content">
    <!-- 顶部栏 -->
    <div class="topbar">
      <div class="topbar-left">
        <div class="search-box">
          <i class="ri-search-line"></i>
          <input type="text" id="globalSearch" placeholder="搜索赛事、球队...">
        </div>
      </div>
      <div class="topbar-right">
        <button class="btn btn-secondary btn-icon" onclick="refreshData()" title="刷新数据">
          <i class="ri-refresh-line"></i>
        </button>
        <button class="btn btn-primary" onclick="showStats()">
          <i class="ri-bar-chart-line"></i>
          统计信息
        </button>
      </div>
    </div>

    <!-- 内容区域 -->
    <div class="content">
      <!-- 数据总览页面 -->
      <div id="page-dashboard" class="page active">
        <div class="page-header">
          <h2 class="page-title">数据总览</h2>
          <p class="page-subtitle">实时监控赔率数据和系统状态</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon blue">
              <i class="ri-database-2-line"></i>
            </div>
            <div class="stat-info">
              <h3 id="stat-isports">0</h3>
              <p>iSports 赛事</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon green">
              <i class="ri-trophy-line"></i>
            </div>
            <div class="stat-info">
              <h3 id="stat-crown">0</h3>
              <p>皇冠赛事</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon purple">
              <i class="ri-link-m"></i>
            </div>
            <div class="stat-info">
              <h3 id="stat-mapped">0</h3>
              <p>已映射球队</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon orange">
              <i class="ri-time-line"></i>
            </div>
            <div class="stat-info">
              <h3 id="stat-update">--</h3>
              <p>最后更新</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">快速概览</h3>
          </div>
          <div class="card-body">
            <div class="tabs">
              <button class="tab active" onclick="switchOverviewTab('live')">滚球</button>
              <button class="tab" onclick="switchOverviewTab('today')">今日</button>
              <button class="tab" onclick="switchOverviewTab('early')">早盘</button>
            </div>
            <div id="overview-content">
              <div class="empty-state">
                <i class="ri-database-2-line"></i>
                <p>加载中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 第三方赔率页面 -->
      <div id="page-thirdparty" class="page" style="display: none;">
        <div class="page-header">
          <h2 class="page-title">第三方赔率数据</h2>
          <p class="page-subtitle">iSportsAPI 和 Odds-API.io 数据</p>
        </div>

        <!-- 统计信息 -->
        <div class="stats-grid" style="margin-bottom: 20px;">
          <div class="stat-card" onclick="switchThirdPartyStatus('live')" style="cursor: pointer;" id="thirdparty-stat-live">
            <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
              <i class="ri-live-line"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">滚球</div>
              <div class="stat-value" id="thirdparty-live-count">0</div>
            </div>
          </div>
          <div class="stat-card" onclick="switchThirdPartyStatus('today')" style="cursor: pointer;" id="thirdparty-stat-today">
            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
              <i class="ri-calendar-line"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">今日</div>
              <div class="stat-value" id="thirdparty-today-count">0</div>
            </div>
          </div>
          <div class="stat-card" onclick="switchThirdPartyStatus('early')" style="cursor: pointer;" id="thirdparty-stat-early">
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
              <i class="ri-calendar-2-line"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">早盘</div>
              <div class="stat-value" id="thirdparty-early-count">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">赛事列表</h3>
            <div class="action-btns">
              <button class="btn btn-success btn-sm" onclick="exportTeams()">
                <i class="ri-team-line"></i> 导出球队
              </button>
              <button class="btn btn-success btn-sm" onclick="exportLeagues()">
                <i class="ri-trophy-line"></i> 导出联赛
              </button>
              <button class="btn btn-secondary btn-sm" onclick="exportData('thirdparty')">
                <i class="ri-download-line"></i> 导出赛事
              </button>
              <button class="btn btn-primary btn-sm" onclick="refreshThirdParty()">
                <i class="ri-refresh-line"></i> 刷新
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="filters">
              <div class="filter-group">
                <label class="filter-label">数据源</label>
                <select id="filter-source" onchange="filterThirdParty()">
                  <option value="all">全部</option>
                  <option value="isports">iSportsAPI</option>
                  <option value="oddsapi">Odds-API.io</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">状态</label>
                <select id="filter-status" onchange="filterThirdParty()">
                  <option value="all">全部</option>
                  <option value="live">滚球</option>
                  <option value="today">今日</option>
                  <option value="early">早盘</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">搜索</label>
                <input type="text" id="filter-search" placeholder="球队名称..." oninput="filterThirdParty()">
              </div>
            </div>
            <div class="matches-container" id="thirdparty-matches">
              <div style="text-align: center; padding: 40px;">
                <div class="loading"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 皇冠赛事页面 -->
      <div id="page-crown" class="page" style="display: none;">
        <div class="page-header">
          <h2 class="page-title">皇冠赛事数据</h2>
          <p class="page-subtitle">Crown 官方赔率数据</p>
        </div>

        <!-- 统计信息 -->
        <div class="stats-grid" style="margin-bottom: 20px;">
          <div class="stat-card" onclick="switchCrownType('live')" style="cursor: pointer;" id="crown-stat-live">
            <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
              <i class="ri-live-line"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">滚球</div>
              <div class="stat-value" id="crown-live-count">0</div>
            </div>
          </div>
          <div class="stat-card" onclick="switchCrownType('today')" style="cursor: pointer;" id="crown-stat-today">
            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
              <i class="ri-calendar-line"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">今日</div>
              <div class="stat-value" id="crown-today-count">0</div>
            </div>
          </div>
          <div class="stat-card" onclick="switchCrownType('early')" style="cursor: pointer;" id="crown-stat-early">
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
              <i class="ri-calendar-2-line"></i>
            </div>
            <div class="stat-content">
              <div class="stat-label">早盘</div>
              <div class="stat-value" id="crown-early-count">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">赛事列表</h3>
            <div class="action-btns">
              <button class="btn btn-secondary btn-sm" onclick="exportData('crown')">
                <i class="ri-download-line"></i> 导出
              </button>
              <button class="btn btn-primary btn-sm" onclick="refreshCrown()">
                <i class="ri-refresh-line"></i> 刷新
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="filters">
              <div class="filter-group">
                <label class="filter-label">类型</label>
                <select id="crown-filter-type" onchange="filterCrown()">
                  <option value="all">全部</option>
                  <option value="live">滚球</option>
                  <option value="today">今日</option>
                  <option value="early">早盘</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">搜索</label>
                <input type="text" id="crown-filter-search" placeholder="球队名称..." oninput="filterCrown()">
              </div>
            </div>
            <div class="matches-container" id="crown-matches">
              <div style="text-align: center; padding: 40px;">
                <div class="loading"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 球队映射页面 -->
      <div id="page-mapping" class="page" style="display: none;">
        <div class="page-header">
          <h2 class="page-title">球队映射管理</h2>
          <p class="page-subtitle">管理第三方数据源与皇冠球队的映射关系</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">球队映射列表</h3>
            <div class="action-btns">
              <button class="btn btn-success btn-sm" onclick="showAddMappingModal()">
                <i class="ri-add-line"></i> 新增映射
              </button>
              <button class="btn btn-primary btn-sm" onclick="showImportMappingModal()">
                <i class="ri-upload-line"></i> 批量导入
              </button>
              <button class="btn btn-secondary btn-sm" onclick="exportData('mapping')">
                <i class="ri-download-line"></i> 导出
              </button>
              <button class="btn btn-danger btn-sm" id="batch-delete-mapping-btn" onclick="batchDeleteMapping()" style="display: none;">
                <i class="ri-delete-bin-line"></i> 批量删除 (<span id="selected-mapping-count">0</span>)
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="filters">
              <div class="filter-group">
                <label class="filter-label">搜索</label>
                <input type="text" id="mapping-search" placeholder="球队名称..." oninput="searchMapping()">
              </div>
              <div class="filter-group">
                <label class="filter-label">验证状态</label>
                <select id="mapping-verified-filter" onchange="searchMapping()">
                  <option value="">全部</option>
                  <option value="true">已验证</option>
                  <option value="false">未验证</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">每页显示</label>
                <select id="mapping-page-size" onchange="changeMappingPageSize()">
                  <option value="20">20 条</option>
                  <option value="50" selected>50 条</option>
                  <option value="100">100 条</option>
                </select>
              </div>
            </div>
            <div class="table-container">
              <table id="mapping-table">
                <thead>
                  <tr>
                    <th style="width: 50px;">
                      <input type="checkbox" id="select-all-mapping" onchange="toggleSelectAllMapping()">
                    </th>
                    <th>iSports 英文名</th>
                    <th>iSports 中文名</th>
                    <th>皇冠中文名</th>
                    <th>验证状态</th>
                    <th>创建时间</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="mapping-tbody">
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                      <div class="loading"></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div id="mapping-pagination" class="pagination" style="display: none;">
              <button class="btn btn-sm" onclick="goToMappingPage(1)" id="mapping-first-page">首页</button>
              <button class="btn btn-sm" onclick="goToMappingPage(currentMappingPage - 1)" id="mapping-prev-page">上一页</button>
              <span id="mapping-page-info" style="margin: 0 15px;">第 1 页 / 共 1 页</span>
              <button class="btn btn-sm" onclick="goToMappingPage(currentMappingPage + 1)" id="mapping-next-page">下一页</button>
              <button class="btn btn-sm" onclick="goToMappingPage(totalMappingPages)" id="mapping-last-page">末页</button>
              <span style="margin-left: 15px;">共 <span id="mapping-total-count">0</span> 条</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 联赛映射页面 -->
      <div id="page-league-mapping" class="page" style="display: none;">
        <div class="page-header">
          <h2 class="page-title">联赛映射管理</h2>
          <p class="page-subtitle">管理 iSports 与皇冠联赛的映射关系</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">联赛映射列表</h3>
            <div class="action-btns">
              <button class="btn btn-success btn-sm" onclick="showAddLeagueMappingModal()">
                <i class="ri-add-line"></i> 新增映射
              </button>
              <button class="btn btn-primary btn-sm" onclick="showImportLeagueMappingModal()">
                <i class="ri-upload-line"></i> 批量导入
              </button>
              <button class="btn btn-secondary btn-sm" onclick="exportData('league-mapping')">
                <i class="ri-download-line"></i> 导出
              </button>
              <button class="btn btn-danger btn-sm" id="batch-delete-league-btn" onclick="batchDeleteLeague()" style="display: none;">
                <i class="ri-delete-bin-line"></i> 批量删除 (<span id="selected-league-count">0</span>)
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="filters">
              <div class="filter-group">
                <label class="filter-label">搜索</label>
                <input type="text" id="league-mapping-search" placeholder="联赛名称..." oninput="searchLeagueMapping()">
              </div>
              <div class="filter-group">
                <label class="filter-label">验证状态</label>
                <select id="league-mapping-verified-filter" onchange="searchLeagueMapping()">
                  <option value="">全部</option>
                  <option value="true">已验证</option>
                  <option value="false">未验证</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">每页显示</label>
                <select id="league-page-size" onchange="changeLeaguePageSize()">
                  <option value="20">20 条</option>
                  <option value="50" selected>50 条</option>
                  <option value="100">100 条</option>
                </select>
              </div>
            </div>
            <div class="table-container">
              <table id="league-mapping-table">
                <thead>
                  <tr>
                    <th style="width: 50px;">
                      <input type="checkbox" id="select-all-league" onchange="toggleSelectAllLeague()">
                    </th>
                    <th>iSports 英文名</th>
                    <th>iSports 中文名</th>
                    <th>皇冠中文名</th>
                    <th>验证状态</th>
                    <th>创建时间</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="league-mapping-tbody">
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                      <div class="loading"></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- 分页控件 -->
            <div id="league-pagination" class="pagination" style="display: none;">
              <button class="btn btn-sm" onclick="goToLeaguePage(1)" id="league-first-page">首页</button>
              <button class="btn btn-sm" onclick="goToLeaguePage(currentLeaguePage - 1)" id="league-prev-page">上一页</button>
              <span id="league-page-info" style="margin: 0 15px;">第 1 页 / 共 1 页</span>
              <button class="btn btn-sm" onclick="goToLeaguePage(currentLeaguePage + 1)" id="league-next-page">下一页</button>
              <button class="btn btn-sm" onclick="goToLeaguePage(totalLeaguePages)" id="league-last-page">末页</button>
              <span style="margin-left: 15px;">共 <span id="league-total-count">0</span> 条</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 赛事推送页面 -->
      <div id="page-match-push" class="page" style="display: none;">
        <div class="page-header">
          <h2 class="page-title">赛事推送</h2>
          <p class="page-subtitle">皇冠赛事 + iSports 数据补充</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">赛事列表</h3>
            <div class="action-btns">
              <button class="btn btn-primary btn-sm" onclick="loadMatchPushData()">
                <i class="ri-refresh-line"></i> 刷新
              </button>
            </div>
          </div>
          <div class="card-body">
            <!-- 统计信息 -->
            <div id="match-push-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div class="stat-card">
                <div class="stat-label">总赛事数</div>
                <div class="stat-value" id="stat-total">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">已匹配</div>
                <div class="stat-value" id="stat-matched" style="color: var(--success);">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">未匹配</div>
                <div class="stat-value" id="stat-unmatched" style="color: var(--warning);">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">匹配率</div>
                <div class="stat-value" id="stat-rate">0%</div>
              </div>
            </div>

            <!-- 筛选器 -->
            <div class="filters">
              <div class="filter-group">
                <label class="filter-label">赛事类型</label>
                <select id="match-push-type" onchange="loadMatchPushData()">
                  <option value="live">滚球</option>
                  <option value="today">今日</option>
                  <option value="early">早盘</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">匹配状态</label>
                <select id="match-push-filter" onchange="filterMatchPush()">
                  <option value="all">全部</option>
                  <option value="matched">已匹配</option>
                  <option value="unmatched">未匹配</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">每页显示</label>
                <select id="match-push-page-size" onchange="changeMatchPushPageSize()">
                  <option value="20">20 条</option>
                  <option value="50" selected>50 条</option>
                  <option value="100">100 条</option>
                </select>
              </div>
            </div>

            <!-- 赛事列表 -->
            <div id="match-push-container" style="margin-top: 20px;">
              <div style="text-align: center; padding: 40px;">
                <div class="loading"></div>
              </div>
            </div>

            <!-- 分页控件 -->
            <div id="match-push-pagination" class="pagination" style="display: none;">
              <button class="btn btn-sm" onclick="goToMatchPushPage(1)" id="match-push-first-page">首页</button>
              <button class="btn btn-sm" onclick="goToMatchPushPage(currentMatchPushPage - 1)" id="match-push-prev-page">上一页</button>
              <span id="match-push-page-info" style="margin: 0 15px;">第 1 页 / 共 1 页</span>
              <button class="btn btn-sm" onclick="goToMatchPushPage(currentMatchPushPage + 1)" id="match-push-next-page">下一页</button>
              <button class="btn btn-sm" onclick="goToMatchPushPage(totalMatchPushPages)" id="match-push-last-page">末页</button>
              <span style="margin-left: 15px;">共 <span id="match-push-total-count">0</span> 条</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 赛事匹配页面 -->
      <div id="page-match-compare" class="page" style="display: none;">
        <div class="page-header">
          <h2 class="page-title">赛事匹配</h2>
          <p class="page-subtitle">对比皇冠和 iSports 赛事，智能匹配同一场比赛</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">赛事对比</h3>
            <div class="action-btns">
              <button class="btn btn-success btn-sm" onclick="exportMatchCompare()">
                <i class="ri-file-excel-2-line"></i> 导出 Excel
              </button>
              <button class="btn btn-primary btn-sm" onclick="loadMatchCompareData()">
                <i class="ri-refresh-line"></i> 刷新
              </button>
            </div>
          </div>
          <div class="card-body">
            <!-- 统计信息 -->
            <div id="match-compare-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div class="stat-card">
                <div class="stat-label">皇冠赛事</div>
                <div class="stat-value" id="compare-crown-count">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">iSports 赛事</div>
                <div class="stat-value" id="compare-isports-count">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">AI 匹配</div>
                <div class="stat-value" id="compare-ai-matched" style="color: var(--success);">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">手动匹配</div>
                <div class="stat-value" id="compare-manual-matched" style="color: var(--primary);">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">未匹配</div>
                <div class="stat-value" id="compare-unmatched" style="color: var(--warning);">0</div>
              </div>
            </div>

            <!-- 筛选器 -->
            <div class="filters">
              <div class="filter-group">
                <label class="filter-label">赛事类型</label>
                <select id="compare-type" onchange="loadMatchCompareData()">
                  <option value="live">滚球</option>
                  <option value="today">今日</option>
                  <option value="early">早盘</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">匹配状态</label>
                <select id="compare-filter" onchange="filterMatchCompare()">
                  <option value="all">全部</option>
                  <option value="ai-matched">AI 匹配</option>
                  <option value="manual-matched">手动匹配</option>
                  <option value="unmatched">未匹配</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">时间范围</label>
                <select id="compare-time-range" onchange="loadMatchCompareData()">
                  <option value="all">全部</option>
                  <option value="1h">1小时内</option>
                  <option value="3h">3小时内</option>
                  <option value="6h">6小时内</option>
                  <option value="12h">12小时内</option>
                  <option value="24h">24小时内</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">联赛筛选</label>
                <input type="text" id="compare-league-filter" placeholder="输入联赛名称" onkeyup="filterMatchCompare()" class="form-control">
              </div>
            </div>

            <!-- 赛事对比列表 -->
            <div id="match-compare-container" style="margin-top: 20px;">
              <div style="text-align: center; padding: 40px;">
                <div class="loading"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 球队映射编辑模态框 -->
  <div id="mapping-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title" id="mapping-modal-title">新增球队映射</h3>
        <button class="modal-close" onclick="closeMappingModal()">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="mapping-form">
          <div class="form-group">
            <label class="form-label">iSports 英文名 *</label>
            <input type="text" class="form-control" id="isports-en" required placeholder="例如: Manchester United">
          </div>
          <div class="form-group">
            <label class="form-label">iSports 中文名 *</label>
            <input type="text" class="form-control" id="isports-cn" required placeholder="例如: 曼联">
          </div>
          <div class="form-group">
            <label class="form-label">皇冠中文名 *</label>
            <input type="text" class="form-control" id="crown-cn" required placeholder="例如: 曼联">
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="mapping-verified" style="margin-right: 8px;">
              已验证
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeMappingModal()">取消</button>
        <button class="btn btn-primary" onclick="saveMapping()">保存</button>
      </div>
    </div>
  </div>

  <!-- 球队映射批量导入模态框 -->
  <div id="mapping-import-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">批量导入球队映射</h3>
        <button class="modal-close" onclick="closeImportMappingModal()">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- 导入方式选择 -->
        <div class="tabs" style="margin-bottom: 20px;">
          <button class="tab active" onclick="switchImportTab('excel')">Excel 导入</button>
          <button class="tab" onclick="switchImportTab('json')">JSON 导入</button>
        </div>

        <!-- Excel 导入 -->
        <div id="import-excel-tab" class="import-tab-content">
          <div class="form-group">
            <label class="form-label">选择 Excel 文件</label>
            <input type="file" id="mapping-excel-file" class="form-control" accept=".xlsx,.xls" onchange="handleExcelFileSelect(event, 'mapping')">
            <p style="margin-top: 8px; color: var(--text-muted); font-size: 14px;">
              <i class="ri-information-line"></i> 支持 .xlsx 和 .xls 格式，最大 5MB
            </p>
          </div>
          <div class="form-group">
            <label class="form-label">Excel 格式要求</label>
            <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; font-size: 14px;">
              <p style="margin: 0 0 10px 0;"><strong>列顺序：</strong></p>
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: rgba(59, 130, 246, 0.2);">
                    <th style="padding: 8px; text-align: left; border: 1px solid rgba(59, 130, 246, 0.3);">isports_en</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid rgba(59, 130, 246, 0.3);">isports_cn</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid rgba(59, 130, 246, 0.3);">crown_cn</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Manchester United</td>
                    <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">曼联</td>
                    <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">曼联</td>
                  </tr>
                </tbody>
              </table>
              <p style="margin: 10px 0 0 0; color: var(--warning);"><i class="ri-alert-line"></i> 第一行为表头，会被自动忽略</p>
            </div>
          </div>
        </div>

        <!-- JSON 导入 -->
        <div id="import-json-tab" class="import-tab-content" style="display: none;">
          <div class="form-group">
            <label class="form-label">JSON 数据</label>
            <textarea id="mapping-import-data" class="form-control" rows="10" placeholder='[
  {
    "isports_en": "Manchester United",
    "isports_cn": "曼联",
    "crown_cn": "曼联",
    "verified": true
  },
  {
    "isports_en": "Liverpool",
    "isports_cn": "利物浦",
    "crown_cn": "利物浦",
    "verified": true
  }
]'></textarea>
            <p style="margin-top: 8px; color: var(--text-muted); font-size: 14px;">
              请输入 JSON 格式的球队映射数据数组
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImportMappingModal()">取消</button>
        <button class="btn btn-primary" onclick="importMappings()">导入</button>
      </div>
    </div>
  </div>

  <!-- 联赛映射编辑模态框 -->
  <div id="league-mapping-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="league-mapping-modal-title">新增联赛映射</h3>
        <button class="modal-close" onclick="closeLeagueMappingModal()">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="league-mapping-form">
          <div class="form-group">
            <label class="form-label">iSports 英文名 *</label>
            <input type="text" class="form-control" id="isports-en" required placeholder="例如: English Premier League">
          </div>
          <div class="form-group">
            <label class="form-label">iSports 中文名 *</label>
            <input type="text" class="form-control" id="isports-cn" required placeholder="例如: 英格兰超级联赛">
          </div>
          <div class="form-group">
            <label class="form-label">皇冠中文名 *</label>
            <input type="text" class="form-control" id="crown-cn" required placeholder="例如: 英超">
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="verified" style="margin-right: 8px;">
              已验证
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeLeagueMappingModal()">取消</button>
        <button class="btn btn-primary" onclick="saveLeagueMapping()">保存</button>
      </div>
    </div>
  </div>

  <!-- 联赛映射批量导入模态框 -->
  <div id="league-mapping-import-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title">批量导入联赛映射</h3>
        <button class="modal-close" onclick="closeImportLeagueMappingModal()">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- 导入方式选择 -->
        <div class="tabs" style="margin-bottom: 20px;">
          <button class="tab active" onclick="switchLeagueImportTab('excel')">Excel 导入</button>
          <button class="tab" onclick="switchLeagueImportTab('json')">JSON 导入</button>
        </div>

        <!-- Excel 导入 -->
        <div id="league-import-excel-tab" class="import-tab-content">
          <div class="form-group">
            <label class="form-label">选择 Excel 文件</label>
            <input type="file" id="league-mapping-excel-file" class="form-control" accept=".xlsx,.xls" onchange="handleExcelFileSelect(event, 'league')">
            <p style="margin-top: 8px; color: var(--text-muted); font-size: 14px;">
              <i class="ri-information-line"></i> 支持 .xlsx 和 .xls 格式，最大 5MB
            </p>
          </div>
          <div class="form-group">
            <label class="form-label">Excel 格式要求</label>
            <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; font-size: 14px;">
              <p style="margin: 0 0 10px 0;"><strong>列顺序：</strong></p>
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: rgba(59, 130, 246, 0.2);">
                    <th style="padding: 8px; text-align: left; border: 1px solid rgba(59, 130, 246, 0.3);">isports_en</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid rgba(59, 130, 246, 0.3);">isports_cn</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid rgba(59, 130, 246, 0.3);">crown_cn</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Premier League</td>
                    <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">英超</td>
                    <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">英格兰超级联赛</td>
                  </tr>
                </tbody>
              </table>
              <p style="margin: 10px 0 0 0; color: var(--warning);"><i class="ri-alert-line"></i> 第一行为表头，会被自动忽略</p>
            </div>
          </div>
        </div>

        <!-- JSON 导入 -->
        <div id="league-import-json-tab" class="import-tab-content" style="display: none;">
          <div class="form-group">
            <label class="form-label">JSON 数据</label>
            <textarea id="league-mapping-import-data" class="form-control" rows="15" placeholder='[
  {
    "isports_en": "English Premier League",
    "isports_cn": "英格兰超级联赛",
    "crown_cn": "英超",
    "verified": true
  }
]'></textarea>
            <p style="margin-top: 8px; color: var(--text-muted); font-size: 14px;">
              请输入 JSON 格式的联赛映射数据数组
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeImportLeagueMappingModal()">取消</button>
        <button class="btn btn-primary" onclick="importLeagueMappings()">导入</button>
      </div>
    </div>
  </div>

  <script>
    // 全局数据
    let thirdpartyData = [];
    let crownData = [];
    let mappingData = [];
    let leagueMappingData = [];
    let matchPushData = [];
    let filteredThirdparty = [];
    let filteredCrown = [];
    let filteredMatchPush = [];

    // 页面切换
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', function() {
        const page = this.dataset.page;

        // 更新导航状态
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        this.classList.add('active');

        // 切换页面
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.getElementById(`page-${page}`).style.display = 'block';

        // 加载对应数据
        if (page === 'thirdparty') loadThirdPartyData('live');
        else if (page === 'crown') loadCrownData('live');
        else if (page === 'mapping') loadMappingData();
        else if (page === 'league-mapping') loadLeagueMappingData();
        else if (page === 'match-push') loadMatchPushData();
        else if (page === 'match-compare') loadMatchCompareData();
        else if (page === 'dashboard') loadDashboard();
      });
    });

    // 初始化
    async function init() {
      await loadDashboard();
      setInterval(updateStats, 30000); // 每30秒更新统计
    }

    // 加载仪表板
    async function loadDashboard() {
      try {
        const [statusRes, isportsRes] = await Promise.all([
          fetch('/api/thirdparty/status'),
          fetch('/api/thirdparty/isports')
        ]);

        const status = await statusRes.json();
        const isports = await isportsRes.json();

        // 更新统计卡片
        document.getElementById('stat-isports').textContent = status.isportsCount || 0;
        document.getElementById('stat-crown').textContent = '加载中...';
        document.getElementById('stat-mapped').textContent = '加载中...';

        // 更新时间
        if (status.lastUpdate?.isports) {
          const time = new Date(status.lastUpdate.isports).toLocaleTimeString('zh-CN');
          document.getElementById('stat-update').textContent = time;
        }

        // 加载快速概览
        switchOverviewTab('live');
      } catch (error) {
        console.error('加载仪表板失败:', error);
      }
    }

    // 切换概览标签
    async function switchOverviewTab(status) {
      // 更新标签状态
      document.querySelectorAll('.tabs .tab').forEach(tab => tab.classList.remove('active'));
      event?.target?.classList.add('active');

      const content = document.getElementById('overview-content');
      content.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div></div>';

      try {
        const res = await fetch(`/api/thirdparty/isports?status=${status}`);
        const data = await res.json();

        if (data.success && data.data.length > 0) {
          const matches = data.data.slice(0, 10); // 只显示前10场
          content.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>联赛</th>
                  <th>主队</th>
                  <th>客队</th>
                  <th>开赛时间</th>
                  <th>欧赔</th>
                </tr>
              </thead>
              <tbody>
                ${matches.map(m => `
                  <tr>
                    <td>${m.league_name_cn || m.league_name_en}</td>
                    <td>${m.team_home_cn || m.team_home_en}</td>
                    <td>${m.team_away_cn || m.team_away_en}</td>
                    <td>${formatTime(m.match_time)}</td>
                    <td>
                      ${m.odds?.europe ? `
                        <div class="odds-group">
                          <span class="odds-value">${m.odds.europe.home_odds}</span>
                          <span class="odds-value">${m.odds.europe.draw_odds}</span>
                          <span class="odds-value">${m.odds.europe.away_odds}</span>
                        </div>
                      ` : '-'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          content.innerHTML = `
            <div class="empty-state">
              <i class="ri-inbox-line"></i>
              <p>暂无${status === 'live' ? '滚球' : status === 'today' ? '今日' : '早盘'}赛事</p>
            </div>
          `;
        }
      } catch (error) {
        content.innerHTML = `
          <div class="empty-state">
            <i class="ri-error-warning-line"></i>
            <p>加载失败: ${error.message}</p>
          </div>
        `;
      }
    }

    // 加载第三方数据
    async function loadThirdPartyData(defaultStatus = 'live') {
      try {
        const res = await fetch('/api/thirdparty/isports');
        const data = await res.json();

        if (data.success) {
          thirdpartyData = data.data;

          // 更新统计信息
          const liveCount = thirdpartyData.filter(m => m.status === 'live').length;
          const todayCount = thirdpartyData.filter(m => m.status === 'today').length;
          const earlyCount = thirdpartyData.filter(m => m.status === 'early').length;

          document.getElementById('thirdparty-live-count').textContent = liveCount;
          document.getElementById('thirdparty-today-count').textContent = todayCount;
          document.getElementById('thirdparty-early-count').textContent = earlyCount;

          // 默认显示滚球数据
          document.getElementById('filter-status').value = defaultStatus;
          switchThirdPartyStatus(defaultStatus);
        }
      } catch (error) {
        console.error('加载第三方数据失败:', error);
        document.getElementById('thirdparty-matches').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">加载失败: ${error.message}</div>
        `;
      }
    }

    // 渲染第三方数据表格
    function renderThirdPartyTable() {
      const container = document.getElementById('thirdparty-matches');

      if (filteredThirdparty.length === 0) {
        const currentStatus = document.getElementById('filter-status').value;
        const liveCount = thirdpartyData.filter(m => m.status === 'live').length;
        const todayCount = thirdpartyData.filter(m => m.status === 'today').length;
        const earlyCount = thirdpartyData.filter(m => m.status === 'early').length;

        let suggestion = '';
        if (currentStatus === 'live' && todayCount > 0) {
          suggestion = `<button class="btn btn-primary" onclick="switchThirdPartyStatus('today')" style="margin-top: 15px;">查看今日赛事 (${todayCount}场)</button>`;
        } else if (currentStatus === 'live' && earlyCount > 0) {
          suggestion = `<button class="btn btn-primary" onclick="switchThirdPartyStatus('early')" style="margin-top: 15px;">查看早盘赛事 (${earlyCount}场)</button>`;
        } else if (currentStatus === 'today' && liveCount > 0) {
          suggestion = `<button class="btn btn-primary" onclick="switchThirdPartyStatus('live')" style="margin-top: 15px;">查看滚球赛事 (${liveCount}场)</button>`;
        } else if (currentStatus === 'today' && earlyCount > 0) {
          suggestion = `<button class="btn btn-primary" onclick="switchThirdPartyStatus('early')" style="margin-top: 15px;">查看早盘赛事 (${earlyCount}场)</button>`;
        }

        container.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <i class="ri-inbox-line" style="font-size: 48px; color: var(--text-muted); margin-bottom: 15px;"></i>
            <div style="color: var(--text-muted); margin-bottom: 10px;">暂无${getStatusText(currentStatus)}数据</div>
            ${suggestion}
          </div>
        `;
        return;
      }

      container.innerHTML = filteredThirdparty.map(match => {
        const europeOdds = match.odds?.moneyline || {}; // 独赢盘
        const handicapOdds = match.odds?.handicap || []; // 让球盘（数组，支持多盘口）
        const overUnderOdds = match.odds?.totals || []; // 大小球（数组，支持多盘口）

        // 渲染让球盘（支持多盘口）
        const renderHandicap = () => {
          if (!Array.isArray(handicapOdds) || handicapOdds.length === 0) {
            return `
              <div class="odds-group-cell">
                <div class="odds-item handicap">-</div>
                <div class="odds-item">-</div>
                <div class="odds-item">-</div>
              </div>
            `;
          }

          return handicapOdds.map((h, idx) => `
            <div class="odds-group-cell" style="${idx > 0 ? 'opacity: 0.7; font-size: 0.9em;' : ''}">
              <div class="odds-item handicap" title="${idx === 0 ? '主盘' : '备选盘 ' + h.handicap_index}">${h.handicap_line || '-'}</div>
              <div class="odds-item">${h.home_odds || '-'}</div>
              <div class="odds-item">${h.away_odds || '-'}</div>
            </div>
          `).join('');
        };

        // 渲染大小球（支持多盘口）
        const renderOverUnder = () => {
          if (!Array.isArray(overUnderOdds) || overUnderOdds.length === 0) {
            return `
              <div class="odds-group-cell">
                <div class="odds-item handicap">-</div>
                <div class="odds-item">-</div>
                <div class="odds-item">-</div>
              </div>
            `;
          }

          return overUnderOdds.map((o, idx) => `
            <div class="odds-group-cell" style="${idx > 0 ? 'opacity: 0.7; font-size: 0.9em;' : ''}">
              <div class="odds-item handicap" title="${idx === 0 ? '主盘' : '备选盘 ' + o.handicap_index}">${o.total_line || '-'}</div>
              <div class="odds-item">${o.over_odds || '-'}</div>
              <div class="odds-item">${o.under_odds || '-'}</div>
            </div>
          `).join('');
        };

        return `
        <div class="match-card">
          <div class="match-header">
            <div class="team-home">${match.team_home_cn || match.team_home_en}</div>
            <div class="match-info">
              <div>${match.league_name_cn || match.league_name_en} <span class="badge badge-${match.status}">${getStatusText(match.status)}</span></div>
              <div class="match-time">${formatTime(match.match_time)}</div>
            </div>
            <div class="team-away">${match.team_away_cn || match.team_away_en}</div>
          </div>

          <!-- 赔率表头 -->
          <div class="match-odds-header">
            <div class="header-cell">独赢(1/2/X)</div>
            <div class="header-cell">让球(1/2)</div>
            <div class="header-cell">大/小(O/U)</div>
            <div class="header-cell">独赢(半场)</div>
            <div class="header-cell">让球(半场)</div>
            <div class="header-cell">大/小(O/U半)</div>
            <div class="header-cell">操作</div>
          </div>

          <div class="match-body">
            <!-- 独赢(1/2/X) -->
            <div class="odds-group-cell">
              <div class="odds-item">${europeOdds.home_odds || '-'}</div>
              <div class="odds-item">${europeOdds.draw_odds || '-'}</div>
              <div class="odds-item">${europeOdds.away_odds || '-'}</div>
            </div>

            <!-- 让球(1/2) - 支持多盘口 -->
            ${renderHandicap()}

            <!-- 大/小(O/U) - 支持多盘口 -->
            ${renderOverUnder()}

            <!-- 独赢(半场) -->
            <div class="odds-group-cell">
              <div class="odds-item">-</div>
              <div class="odds-item">-</div>
              <div class="odds-item">-</div>
            </div>

            <!-- 让球(半场) -->
            <div class="odds-group-cell">
              <div class="odds-item handicap">-</div>
              <div class="odds-item">-</div>
              <div class="odds-item">-</div>
            </div>

            <!-- 大/小(O/U半) -->
            <div class="odds-group-cell">
              <div class="odds-item handicap">-</div>
              <div class="odds-item">-</div>
              <div class="odds-item">-</div>
            </div>

            <div class="action-cell">
              <button class="btn btn-secondary btn-sm" onclick="viewMatchDetail('${match.match_id}')">
                <i class="ri-eye-line"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      }).join('');
    }

    // 切换第三方数据状态
    function switchThirdPartyStatus(status) {
      document.getElementById('filter-status').value = status;

      // 更新统计卡片高亮
      document.querySelectorAll('[id^="thirdparty-stat-"]').forEach(card => {
        card.style.opacity = '0.6';
        card.style.transform = 'scale(1)';
      });
      document.getElementById(`thirdparty-stat-${status}`).style.opacity = '1';
      document.getElementById(`thirdparty-stat-${status}`).style.transform = 'scale(1.05)';

      filterThirdParty();
    }

    // 筛选第三方数据
    function filterThirdParty() {
      const source = document.getElementById('filter-source').value;
      const status = document.getElementById('filter-status').value;
      const search = document.getElementById('filter-search').value.toLowerCase();

      filteredThirdparty = thirdpartyData.filter(match => {
        const matchStatus = status === 'all' || match.status === status;
        const matchSearch = !search ||
          (match.team_home_cn && match.team_home_cn.toLowerCase().includes(search)) ||
          (match.team_away_cn && match.team_away_cn.toLowerCase().includes(search)) ||
          (match.team_home_en && match.team_home_en.toLowerCase().includes(search)) ||
          (match.team_away_en && match.team_away_en.toLowerCase().includes(search));

        return matchStatus && matchSearch;
      });

      renderThirdPartyTable();
    }

    // 加载皇冠数据
    async function loadCrownData(defaultType = 'live') {
      try {
        const res = await fetch('/api/matches');
        const data = await res.json();

        if (data.success) {
          crownData = data.data || [];

          // 更新统计信息
          const liveCount = crownData.filter(m => m.showType === 'live').length;
          const todayCount = crownData.filter(m => m.showType === 'today').length;
          const earlyCount = crownData.filter(m => m.showType === 'early').length;

          document.getElementById('crown-live-count').textContent = liveCount;
          document.getElementById('crown-today-count').textContent = todayCount;
          document.getElementById('crown-early-count').textContent = earlyCount;
          document.getElementById('stat-crown').textContent = crownData.length;

          // 默认显示滚球数据
          document.getElementById('crown-filter-type').value = defaultType;
          switchCrownType(defaultType);
        }
      } catch (error) {
        console.error('加载皇冠数据失败:', error);
        document.getElementById('crown-matches').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">加载失败: ${error.message}</div>
        `;
      }
    }

    // 渲染皇冠数据表格
    function renderCrownTable() {
      const container = document.getElementById('crown-matches');

      if (filteredCrown.length === 0) {
        const currentType = document.getElementById('crown-filter-type').value;
        const liveCount = crownData.filter(m => m.showType === 'live').length;
        const todayCount = crownData.filter(m => m.showType === 'today').length;
        const earlyCount = crownData.filter(m => m.showType === 'early').length;

        let suggestion = '';
        if (currentType === 'live' && todayCount > 0) {
          suggestion = `<button class="btn btn-primary" onclick="switchCrownType('today')" style="margin-top: 15px;">查看今日赛事 (${todayCount}场)</button>`;
        } else if (currentType === 'live' && earlyCount > 0) {
          suggestion = `<button class="btn btn-primary" onclick="switchCrownType('early')" style="margin-top: 15px;">查看早盘赛事 (${earlyCount}场)</button>`;
        } else if (currentType === 'today' && liveCount > 0) {
          suggestion = `<button class="btn btn-primary" onclick="switchCrownType('live')" style="margin-top: 15px;">查看滚球赛事 (${liveCount}场)</button>`;
        } else if (currentType === 'today' && earlyCount > 0) {
          suggestion = `<button class="btn btn-primary" onclick="switchCrownType('early')" style="margin-top: 15px;">查看早盘赛事 (${earlyCount}场)</button>`;
        }

        container.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <i class="ri-inbox-line" style="font-size: 48px; color: var(--text-muted); margin-bottom: 15px;"></i>
            <div style="color: var(--text-muted); margin-bottom: 10px;">暂无${getStatusText(currentType)}数据</div>
            ${suggestion}
          </div>
        `;
        return;
      }

      container.innerHTML = filteredCrown.map(match => {
        // 全场数据（暂时为空，等待第三方映射）
        const fullMoneyline = match.markets?.moneyline || {};
        const fullHandicap = match.markets?.full?.handicapLines?.[0] || {};
        const fullOverUnder = match.markets?.full?.overUnderLines?.[0] || {};

        // 半场数据（暂时为空，等待第三方映射）
        const halfMoneyline = match.markets?.halfMoneyline || {};
        const halfHandicap = match.markets?.half?.handicapLines?.[0] || {};
        const halfOverUnder = match.markets?.half?.overUnderLines?.[0] || {};

        // 显示时间：滚球显示实时状态（如 2H^82:14），其他显示比赛时间
        const displayTime = match.showType === 'live' && match.live_status
          ? match.live_status
          : (match.match_time ? formatTime(match.match_time) : '-');

        return `
        <div class="match-card">
          <div class="match-header">
            <div class="team-home">${match.home_zh || '-'}</div>
            <div class="match-info">
              <div>
                <span style="color: #64748b; font-size: 11px; margin-right: 8px;">GID: ${match.gid}</span>
                ${match.league_zh || '-'}
                <span class="badge badge-${match.showType}">${getStatusText(match.showType)}</span>
              </div>
              <div class="match-time">${displayTime}</div>
            </div>
            <div class="team-away">${match.away_zh || '-'}</div>
          </div>

          <!-- 赔率表头 -->
          <div class="match-odds-header">
            <div class="header-cell">独赢(1/2/X)</div>
            <div class="header-cell">让球(1/2)</div>
            <div class="header-cell">大/小(O/U)</div>
            <div class="header-cell">独赢(半场)</div>
            <div class="header-cell">让球(半场)</div>
            <div class="header-cell">大/小(O/U半)</div>
            <div class="header-cell">操作</div>
          </div>

          <div class="match-body">
            <!-- 独赢(1/2/X) -->
            <div class="odds-group-cell">
              <div class="odds-item">${fullMoneyline.home || '-'}</div>
              <div class="odds-item">${fullMoneyline.draw || '-'}</div>
              <div class="odds-item">${fullMoneyline.away || '-'}</div>
            </div>

            <!-- 让球(1/2) -->
            <div class="odds-group-cell">
              <div class="odds-item handicap">${fullHandicap.line || '-'}</div>
              <div class="odds-item">${fullHandicap.home || '-'}</div>
              <div class="odds-item">${fullHandicap.away || '-'}</div>
            </div>

            <!-- 大/小(O/U) -->
            <div class="odds-group-cell">
              <div class="odds-item handicap">${fullOverUnder.line || '-'}</div>
              <div class="odds-item">${fullOverUnder.over || '-'}</div>
              <div class="odds-item">${fullOverUnder.under || '-'}</div>
            </div>

            <!-- 独赢(半场) -->
            <div class="odds-group-cell">
              <div class="odds-item">${halfMoneyline.home || '-'}</div>
              <div class="odds-item">${halfMoneyline.draw || '-'}</div>
              <div class="odds-item">${halfMoneyline.away || '-'}</div>
            </div>

            <!-- 让球(半场) -->
            <div class="odds-group-cell">
              <div class="odds-item handicap">${halfHandicap.line || '-'}</div>
              <div class="odds-item">${halfHandicap.home || '-'}</div>
              <div class="odds-item">${halfHandicap.away || '-'}</div>
            </div>

            <!-- 大/小(O/U半) -->
            <div class="odds-group-cell">
              <div class="odds-item handicap">${halfOverUnder.line || '-'}</div>
              <div class="odds-item">${halfOverUnder.over || '-'}</div>
              <div class="odds-item">${halfOverUnder.under || '-'}</div>
            </div>

            <div class="action-cell">
              <button class="btn btn-secondary btn-sm" onclick="viewCrownDetail('${match.gid}')">
                <i class="ri-eye-line"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      }).join('');
    }

    // 切换皇冠数据类型
    function switchCrownType(type) {
      document.getElementById('crown-filter-type').value = type;

      // 更新统计卡片高亮
      document.querySelectorAll('[id^="crown-stat-"]').forEach(card => {
        card.style.opacity = '0.6';
        card.style.transform = 'scale(1)';
      });
      document.getElementById(`crown-stat-${type}`).style.opacity = '1';
      document.getElementById(`crown-stat-${type}`).style.transform = 'scale(1.05)';

      filterCrown();
    }

    // 筛选皇冠数据
    function filterCrown() {
      const type = document.getElementById('crown-filter-type').value;
      const search = document.getElementById('crown-filter-search').value.toLowerCase();

      filteredCrown = crownData.filter(match => {
        const matchType = type === 'all' || match.showType === type;
        const matchSearch = !search ||
          (match.home_zh && match.home_zh.toLowerCase().includes(search)) ||
          (match.away_zh && match.away_zh.toLowerCase().includes(search)) ||
          (match.home_en && match.home_en.toLowerCase().includes(search)) ||
          (match.away_en && match.away_en.toLowerCase().includes(search));

        return matchType && matchSearch;
      });

      renderCrownTable();
    }

    // 球队映射分页变量
    let currentMappingPage = 1;
    let mappingPageSize = 50;
    let totalMappingPages = 1;
    let totalMappingCount = 0;
    let selectedMappingIds = new Set();

    // 加载映射数据
    async function loadMappingData(page = 1) {
      try {
        currentMappingPage = page;
        const search = document.getElementById('mapping-search').value;
        const verified = document.getElementById('mapping-verified-filter').value;

        const params = new URLSearchParams({
          page: page,
          pageSize: mappingPageSize
        });

        if (search) params.append('search', search);
        if (verified) params.append('verified', verified);

        const res = await fetch(`/api/mapping/teams?${params}`);
        const data = await res.json();

        if (data.success) {
          mappingData = data.data || [];
          totalMappingPages = data.pagination.totalPages;
          totalMappingCount = data.pagination.total;
          currentMappingPage = data.pagination.page;

          renderMappingTable();
          updateMappingPagination();

          // 更新统计
          document.getElementById('stat-mapped').textContent = totalMappingCount;
        }
      } catch (error) {
        console.error('加载映射数据失败:', error);
        document.getElementById('mapping-tbody').innerHTML = `
          <tr><td colspan="7" style="text-align: center; color: var(--danger);">加载失败: ${error.message}</td></tr>
        `;
      }
    }

    // 更新分页控件
    function updateMappingPagination() {
      const pagination = document.getElementById('mapping-pagination');
      const pageInfo = document.getElementById('mapping-page-info');
      const totalCountSpan = document.getElementById('mapping-total-count');
      const firstPageBtn = document.getElementById('mapping-first-page');
      const prevPageBtn = document.getElementById('mapping-prev-page');
      const nextPageBtn = document.getElementById('mapping-next-page');
      const lastPageBtn = document.getElementById('mapping-last-page');

      if (totalMappingPages > 1) {
        pagination.style.display = 'flex';
        pageInfo.textContent = `第 ${currentMappingPage} 页 / 共 ${totalMappingPages} 页`;
        totalCountSpan.textContent = totalMappingCount;

        firstPageBtn.disabled = currentMappingPage === 1;
        prevPageBtn.disabled = currentMappingPage === 1;
        nextPageBtn.disabled = currentMappingPage === totalMappingPages;
        lastPageBtn.disabled = currentMappingPage === totalMappingPages;
      } else {
        pagination.style.display = 'none';
      }
    }

    // 跳转到指定页
    function goToMappingPage(page) {
      if (page < 1 || page > totalMappingPages) return;
      loadMappingData(page);
    }

    // 改变每页显示数量
    function changeMappingPageSize() {
      mappingPageSize = parseInt(document.getElementById('mapping-page-size').value);
      loadMappingData(1);
    }

    // 搜索映射
    function searchMapping() {
      loadMappingData(1);
    }

    // 渲染映射表格
    function renderMappingTable() {
      const tbody = document.getElementById('mapping-tbody');

      if (mappingData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">暂无映射数据</td></tr>';
        return;
      }

      tbody.innerHTML = mappingData.map(mapping => `
        <tr>
          <td>
            <input type="checkbox" class="mapping-checkbox" value="${mapping.id}"
              ${selectedMappingIds.has(mapping.id) ? 'checked' : ''}
              onchange="toggleMappingSelection('${mapping.id}')">
          </td>
          <td>${mapping.isports_en}</td>
          <td>${mapping.isports_cn}</td>
          <td>${mapping.crown_cn}</td>
          <td>
            ${mapping.verified
              ? '<span style="color: var(--success);"><i class="ri-checkbox-circle-fill"></i> 已验证</span>'
              : '<span style="color: var(--warning);"><i class="ri-error-warning-fill"></i> 未验证</span>'}
          </td>
          <td>${mapping.created_at ? new Date(mapping.created_at).toLocaleString('zh-CN') : '-'}</td>
          <td>
            <div class="action-btns">
              ${!mapping.verified ? `
                <button class="btn btn-success btn-sm" onclick="verifyMapping('${mapping.id}')" title="验证">
                  <i class="ri-checkbox-circle-line"></i>
                </button>
              ` : ''}
              <button class="btn btn-secondary btn-sm" onclick="editMapping('${mapping.id}')">
                <i class="ri-edit-line"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteMapping('${mapping.id}')">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      updateBatchDeleteButton();
    }

    // 切换单个映射选择
    function toggleMappingSelection(id) {
      if (selectedMappingIds.has(id)) {
        selectedMappingIds.delete(id);
      } else {
        selectedMappingIds.add(id);
      }
      updateBatchDeleteButton();
      updateSelectAllCheckbox();
    }

    // 切换全选
    function toggleSelectAllMapping() {
      const checkbox = document.getElementById('select-all-mapping');
      const checkboxes = document.querySelectorAll('.mapping-checkbox');

      if (checkbox.checked) {
        checkboxes.forEach(cb => {
          selectedMappingIds.add(cb.value);
          cb.checked = true;
        });
      } else {
        checkboxes.forEach(cb => {
          selectedMappingIds.delete(cb.value);
          cb.checked = false;
        });
      }

      updateBatchDeleteButton();
    }

    // 更新全选复选框状态
    function updateSelectAllCheckbox() {
      const checkbox = document.getElementById('select-all-mapping');
      const checkboxes = document.querySelectorAll('.mapping-checkbox');
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

      checkbox.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
      checkbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }

    // 更新批量删除按钮
    function updateBatchDeleteButton() {
      const btn = document.getElementById('batch-delete-mapping-btn');
      const count = document.getElementById('selected-mapping-count');

      count.textContent = selectedMappingIds.size;
      btn.style.display = selectedMappingIds.size > 0 ? 'inline-block' : 'none';
    }

    // 批量删除映射
    async function batchDeleteMapping() {
      if (selectedMappingIds.size === 0) {
        alert('请先选择要删除的映射');
        return;
      }

      if (!confirm(`确定要删除选中的 ${selectedMappingIds.size} 条映射吗？`)) {
        return;
      }

      try {
        const res = await fetch('/api/mapping/teams/batch-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(selectedMappingIds) })
        });

        const data = await res.json();

        if (data.success) {
          alert(data.message);
          selectedMappingIds.clear();
          loadMappingData(currentMappingPage);
        } else {
          alert('批量删除失败: ' + data.error);
        }
      } catch (error) {
        alert('批量删除失败: ' + error.message);
      }
    }



    // 显示新增映射模态框
    function showAddMappingModal() {
      document.getElementById('mapping-modal-title').textContent = '新增球队映射';
      document.getElementById('isports-en').value = '';
      document.getElementById('isports-cn').value = '';
      document.getElementById('crown-cn').value = '';
      document.getElementById('mapping-verified').checked = false;
      document.getElementById('isports-en').dataset.editId = '';
      document.getElementById('mapping-modal').classList.add('show');
    }

    // 编辑映射
    function editMapping(id) {
      const mapping = mappingData.find(m => m.id === id);
      if (!mapping) return;

      document.getElementById('mapping-modal-title').textContent = '编辑球队映射';
      document.getElementById('isports-en').value = mapping.isports_en;
      document.getElementById('isports-cn').value = mapping.isports_cn;
      document.getElementById('crown-cn').value = mapping.crown_cn;
      document.getElementById('mapping-verified').checked = mapping.verified;
      document.getElementById('isports-en').dataset.editId = id;
      document.getElementById('mapping-modal').classList.add('show');
    }

    // 关闭映射模态框
    function closeMappingModal() {
      document.getElementById('mapping-modal').classList.remove('show');
    }

    // 保存映射
    async function saveMapping() {
      const isportsEn = document.getElementById('isports-en').value.trim();
      const isportsCn = document.getElementById('isports-cn').value.trim();
      const crownCn = document.getElementById('crown-cn').value.trim();
      const verified = document.getElementById('mapping-verified').checked;
      const editId = document.getElementById('isports-en').dataset.editId;

      if (!isportsEn || !isportsCn || !crownCn) {
        alert('请填写完整信息');
        return;
      }

      try {
        const url = editId ? `/api/mapping/teams/${editId}` : '/api/mapping/teams';
        const method = editId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            isports_en: isportsEn,
            isports_cn: isportsCn,
            crown_cn: crownCn,
            verified
          })
        });

        const data = await res.json();

        if (data.success) {
          alert(editId ? '更新成功' : '创建成功');
          closeMappingModal();
          loadMappingData();
        } else {
          alert('保存失败: ' + data.error);
        }
      } catch (error) {
        alert('保存失败: ' + error.message);
      }
    }

    // 删除映射
    async function deleteMapping(id) {
      const mapping = mappingData.find(m => m.id === id);
      if (!mapping) return;

      if (!confirm(`确定要删除球队映射 "${mapping.crown.team_home} vs ${mapping.crown.team_away}" 吗？`)) {
        return;
      }

      try {
        const res = await fetch(`/api/mapping/teams/${id}`, {
          method: 'DELETE'
        });

        const data = await res.json();

        if (data.success) {
          alert('删除成功');
          loadMappingData();
        } else {
          alert('删除失败: ' + data.error);
        }
      } catch (error) {
        alert('删除失败: ' + error.message);
      }
    }

    // 验证映射
    async function verifyMapping(id) {
      try {
        const res = await fetch(`/api/mapping/verify/${id}`, {
          method: 'POST'
        });

        const data = await res.json();

        if (data.success) {
          alert('验证成功');
          loadMappingData();
        } else {
          alert('验证失败: ' + data.error);
        }
      } catch (error) {
        alert('验证失败: ' + error.message);
      }
    }

    // 显示批量导入模态框
    function showImportMappingModal() {
      document.getElementById('mapping-import-data').value = '';
      document.getElementById('mapping-import-modal').classList.add('show');
    }

    // 关闭批量导入模态框
    function closeImportMappingModal() {
      document.getElementById('mapping-import-modal').classList.remove('show');
    }

    // 切换导入方式标签
    function switchImportTab(tab) {
      // 更新标签样式
      document.querySelectorAll('#mapping-import-modal .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // 切换内容
      if (tab === 'excel') {
        document.getElementById('import-excel-tab').style.display = 'block';
        document.getElementById('import-json-tab').style.display = 'none';
      } else {
        document.getElementById('import-excel-tab').style.display = 'none';
        document.getElementById('import-json-tab').style.display = 'block';
      }
    }

    // 处理 Excel 文件选择
    function handleExcelFileSelect(event, type) {
      const file = event.target.files[0];
      if (file) {
        console.log(`选择了文件: ${file.name}, 类型: ${type}`);
      }
    }

    // 批量导入映射
    async function importMappings() {
      // 检查当前是哪个标签
      const isExcelTab = document.getElementById('import-excel-tab').style.display !== 'none';

      if (isExcelTab) {
        // Excel 导入
        const fileInput = document.getElementById('mapping-excel-file');
        const file = fileInput.files[0];

        if (!file) {
          alert('请选择 Excel 文件');
          return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
          const res = await fetch('/api/mapping/teams/import-excel', {
            method: 'POST',
            body: formData
          });

          const data = await res.json();

          if (data.success) {
            let message = `导入成功！共导入 ${data.data.imported} 条记录`;
            if (data.data.errors > 0) {
              message += `\n跳过 ${data.data.errors} 条错误记录`;
            }
            alert(message);
            closeImportMappingModal();
            loadMappingData();
            fileInput.value = ''; // 清空文件选择
          } else {
            alert('导入失败: ' + data.error);
          }
        } catch (error) {
          alert('导入失败: ' + error.message);
        }
      } else {
        // JSON 导入
        const jsonData = document.getElementById('mapping-import-data').value.trim();

        if (!jsonData) {
          alert('请输入 JSON 数据');
          return;
        }

        try {
          const mappings = JSON.parse(jsonData);

          if (!Array.isArray(mappings)) {
            alert('数据格式错误：必须是数组');
            return;
          }

          const res = await fetch('/api/mapping/teams/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mappings })
          });

          const data = await res.json();

          if (data.success) {
            alert(`导入成功！共导入 ${data.count} 条记录`);
            closeImportMappingModal();
            loadMappingData();
          } else {
            alert('导入失败: ' + data.error);
          }
        } catch (error) {
          alert('导入失败: ' + error.message);
        }
      }
    }

    // ==================== 联赛映射相关函数 ====================

    // 联赛映射分页变量
    let currentLeaguePage = 1;
    let leaguePageSize = 50;
    let totalLeaguePages = 1;
    let totalLeagueCount = 0;
    let selectedLeagueIds = new Set();

    // 加载联赛映射数据
    async function loadLeagueMappingData(page = 1) {
      try {
        currentLeaguePage = page;
        const search = document.getElementById('league-mapping-search').value;
        const verified = document.getElementById('league-mapping-verified-filter').value;

        const params = new URLSearchParams({
          page: page,
          pageSize: leaguePageSize
        });

        if (search) params.append('search', search);
        if (verified) params.append('verified', verified);

        const res = await fetch(`/api/league-mapping?${params}`);
        const data = await res.json();

        if (data.success) {
          leagueMappingData = data.data || [];
          totalLeaguePages = data.pagination.totalPages;
          totalLeagueCount = data.pagination.total;
          currentLeaguePage = data.pagination.page;

          renderLeagueMappingTable();
          updateLeaguePagination();
        }
      } catch (error) {
        console.error('加载联赛映射数据失败:', error);
        document.getElementById('league-mapping-tbody').innerHTML = `
          <tr><td colspan="7" style="text-align: center; color: var(--danger);">加载失败: ${error.message}</td></tr>
        `;
      }
    }

    // 更新分页控件
    function updateLeaguePagination() {
      const pagination = document.getElementById('league-pagination');
      const pageInfo = document.getElementById('league-page-info');
      const totalCountSpan = document.getElementById('league-total-count');
      const firstPageBtn = document.getElementById('league-first-page');
      const prevPageBtn = document.getElementById('league-prev-page');
      const nextPageBtn = document.getElementById('league-next-page');
      const lastPageBtn = document.getElementById('league-last-page');

      if (totalLeaguePages > 1) {
        pagination.style.display = 'flex';
        pageInfo.textContent = `第 ${currentLeaguePage} 页 / 共 ${totalLeaguePages} 页`;
        totalCountSpan.textContent = totalLeagueCount;

        firstPageBtn.disabled = currentLeaguePage === 1;
        prevPageBtn.disabled = currentLeaguePage === 1;
        nextPageBtn.disabled = currentLeaguePage === totalLeaguePages;
        lastPageBtn.disabled = currentLeaguePage === totalLeaguePages;
      } else {
        pagination.style.display = 'none';
      }
    }

    // 跳转到指定页
    function goToLeaguePage(page) {
      if (page < 1 || page > totalLeaguePages) return;
      loadLeagueMappingData(page);
    }

    // 改变每页显示数量
    function changeLeaguePageSize() {
      leaguePageSize = parseInt(document.getElementById('league-page-size').value);
      loadLeagueMappingData(1);
    }

    // 搜索联赛映射
    function searchLeagueMapping() {
      loadLeagueMappingData(1);
    }

    // 渲染联赛映射表格
    function renderLeagueMappingTable() {
      const tbody = document.getElementById('league-mapping-tbody');

      if (leagueMappingData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">暂无联赛映射数据</td></tr>';
        return;
      }

      tbody.innerHTML = leagueMappingData.map(mapping => `
        <tr>
          <td>
            <input type="checkbox" class="league-checkbox" value="${mapping.id}"
              ${selectedLeagueIds.has(mapping.id) ? 'checked' : ''}
              onchange="toggleLeagueSelection('${mapping.id}')">
          </td>
          <td>${mapping.isports_en}</td>
          <td>${mapping.isports_cn}</td>
          <td>${mapping.crown_cn}</td>
          <td>
            ${mapping.verified
              ? '<span style="color: var(--success);"><i class="ri-checkbox-circle-fill"></i> 已验证</span>'
              : '<span style="color: var(--warning);"><i class="ri-error-warning-fill"></i> 未验证</span>'}
          </td>
          <td>${mapping.created_at ? new Date(mapping.created_at).toLocaleString('zh-CN') : '-'}</td>
          <td>
            <div class="action-btns">
              ${!mapping.verified ? `
                <button class="btn btn-success btn-sm" onclick="verifyLeagueMapping('${mapping.id}')" title="验证">
                  <i class="ri-checkbox-circle-line"></i>
                </button>
              ` : ''}
              <button class="btn btn-secondary btn-sm" onclick="editLeagueMapping('${mapping.id}')">
                <i class="ri-edit-line"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteLeagueMapping('${mapping.id}')">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      updateBatchDeleteLeagueButton();
    }

    // 切换单个联赛选择
    function toggleLeagueSelection(id) {
      if (selectedLeagueIds.has(id)) {
        selectedLeagueIds.delete(id);
      } else {
        selectedLeagueIds.add(id);
      }
      updateBatchDeleteLeagueButton();
      updateSelectAllLeagueCheckbox();
    }

    // 切换全选
    function toggleSelectAllLeague() {
      const checkbox = document.getElementById('select-all-league');
      const checkboxes = document.querySelectorAll('.league-checkbox');

      if (checkbox.checked) {
        checkboxes.forEach(cb => {
          selectedLeagueIds.add(cb.value);
          cb.checked = true;
        });
      } else {
        checkboxes.forEach(cb => {
          selectedLeagueIds.delete(cb.value);
          cb.checked = false;
        });
      }

      updateBatchDeleteLeagueButton();
    }

    // 更新全选复选框状态
    function updateSelectAllLeagueCheckbox() {
      const checkbox = document.getElementById('select-all-league');
      const checkboxes = document.querySelectorAll('.league-checkbox');
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

      checkbox.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
      checkbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }

    // 更新批量删除按钮
    function updateBatchDeleteLeagueButton() {
      const btn = document.getElementById('batch-delete-league-btn');
      const count = document.getElementById('selected-league-count');

      count.textContent = selectedLeagueIds.size;
      btn.style.display = selectedLeagueIds.size > 0 ? 'inline-block' : 'none';
    }

    // 批量删除联赛映射
    async function batchDeleteLeague() {
      if (selectedLeagueIds.size === 0) {
        alert('请先选择要删除的联赛映射');
        return;
      }

      if (!confirm(`确定要删除选中的 ${selectedLeagueIds.size} 条联赛映射吗？`)) {
        return;
      }

      try {
        const res = await fetch('/api/league-mapping/batch-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(selectedLeagueIds) })
        });

        const data = await res.json();

        if (data.success) {
          alert(data.message);
          selectedLeagueIds.clear();
          loadLeagueMappingData(currentLeaguePage);
        } else {
          alert('批量删除失败: ' + data.error);
        }
      } catch (error) {
        alert('批量删除失败: ' + error.message);
      }
    }



    // 显示新增联赛映射模态框
    function showAddLeagueMappingModal() {
      document.getElementById('league-mapping-modal-title').textContent = '新增联赛映射';
      document.getElementById('isports-en').value = '';
      document.getElementById('isports-cn').value = '';
      document.getElementById('crown-cn').value = '';
      document.getElementById('verified').checked = false;
      document.getElementById('isports-en').dataset.editId = '';
      document.getElementById('league-mapping-modal').classList.add('show');
    }

    // 编辑联赛映射
    function editLeagueMapping(id) {
      const mapping = leagueMappingData.find(m => m.id === id);
      if (!mapping) return;

      document.getElementById('league-mapping-modal-title').textContent = '编辑联赛映射';
      document.getElementById('isports-en').value = mapping.isports_en;
      document.getElementById('isports-cn').value = mapping.isports_cn;
      document.getElementById('crown-cn').value = mapping.crown_cn;
      document.getElementById('verified').checked = mapping.verified;
      document.getElementById('isports-en').dataset.editId = id;
      document.getElementById('league-mapping-modal').classList.add('show');
    }

    // 关闭联赛映射模态框
    function closeLeagueMappingModal() {
      document.getElementById('league-mapping-modal').classList.remove('show');
    }

    // 保存联赛映射
    async function saveLeagueMapping() {
      const isportsEn = document.getElementById('isports-en').value.trim();
      const isportsCn = document.getElementById('isports-cn').value.trim();
      const crownCn = document.getElementById('crown-cn').value.trim();
      const verified = document.getElementById('verified').checked;
      const editId = document.getElementById('isports-en').dataset.editId;

      if (!isportsEn || !isportsCn || !crownCn) {
        alert('请填写完整信息');
        return;
      }

      try {
        const url = editId ? `/api/league-mapping/${editId}` : '/api/league-mapping';
        const method = editId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            isports_en: isportsEn,
            isports_cn: isportsCn,
            crown_cn: crownCn,
            verified
          })
        });

        const data = await res.json();

        if (data.success) {
          alert(editId ? '更新成功' : '创建成功');
          closeLeagueMappingModal();
          loadLeagueMappingData();
        } else {
          alert('保存失败: ' + data.error);
        }
      } catch (error) {
        alert('保存失败: ' + error.message);
      }
    }

    // 删除联赛映射
    async function deleteLeagueMapping(id) {
      const mapping = leagueMappingData.find(m => m.id === id);
      if (!mapping) return;

      if (!confirm(`确定要删除联赛映射 "${mapping.isports_cn}" 吗？`)) {
        return;
      }

      try {
        const res = await fetch(`/api/league-mapping/${id}`, {
          method: 'DELETE'
        });

        const data = await res.json();

        if (data.success) {
          alert('删除成功');
          loadLeagueMappingData();
        } else {
          alert('删除失败: ' + data.error);
        }
      } catch (error) {
        alert('删除失败: ' + error.message);
      }
    }

    // 验证联赛映射
    async function verifyLeagueMapping(id) {
      try {
        const res = await fetch(`/api/league-mapping/${id}/verify`, {
          method: 'POST'
        });

        const data = await res.json();

        if (data.success) {
          alert('验证成功');
          loadLeagueMappingData();
        } else {
          alert('验证失败: ' + data.error);
        }
      } catch (error) {
        alert('验证失败: ' + error.message);
      }
    }

    // 显示批量导入模态框
    function showImportLeagueMappingModal() {
      document.getElementById('league-mapping-import-data').value = '';
      document.getElementById('league-mapping-import-modal').classList.add('show');
    }

    // 关闭批量导入模态框
    function closeImportLeagueMappingModal() {
      document.getElementById('league-mapping-import-modal').classList.remove('show');
    }

    // 切换联赛导入方式标签
    function switchLeagueImportTab(tab) {
      // 更新标签样式
      document.querySelectorAll('#league-mapping-import-modal .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // 切换内容
      if (tab === 'excel') {
        document.getElementById('league-import-excel-tab').style.display = 'block';
        document.getElementById('league-import-json-tab').style.display = 'none';
      } else {
        document.getElementById('league-import-excel-tab').style.display = 'none';
        document.getElementById('league-import-json-tab').style.display = 'block';
      }
    }

    // 批量导入联赛映射
    async function importLeagueMappings() {
      // 检查当前是哪个标签
      const isExcelTab = document.getElementById('league-import-excel-tab').style.display !== 'none';

      if (isExcelTab) {
        // Excel 导入
        const fileInput = document.getElementById('league-mapping-excel-file');
        const file = fileInput.files[0];

        if (!file) {
          alert('请选择 Excel 文件');
          return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
          const res = await fetch('/api/league-mapping/import-excel', {
            method: 'POST',
            body: formData
          });

          const data = await res.json();

          if (data.success) {
            let message = `导入成功！共导入 ${data.data.imported} 条记录`;
            if (data.data.errors > 0) {
              message += `\n跳过 ${data.data.errors} 条错误记录`;
            }
            alert(message);
            closeImportLeagueMappingModal();
            loadLeagueMappingData();
            fileInput.value = ''; // 清空文件选择
          } else {
            alert('导入失败: ' + data.error);
          }
        } catch (error) {
          alert('导入失败: ' + error.message);
        }
      } else {
        // JSON 导入
        const jsonData = document.getElementById('league-mapping-import-data').value.trim();

        if (!jsonData) {
          alert('请输入 JSON 数据');
          return;
        }

        try {
          const mappings = JSON.parse(jsonData);

          if (!Array.isArray(mappings)) {
            alert('数据格式错误：必须是数组');
            return;
          }

          const res = await fetch('/api/league-mapping/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mappings })
          });

          const data = await res.json();

          if (data.success) {
            alert(`导入成功！共导入 ${data.imported} 条记录`);
            closeImportLeagueMappingModal();
            loadLeagueMappingData();
          } else {
            alert('导入失败: ' + data.error);
          }
        } catch (error) {
          alert('导入失败: ' + error.message);
        }
      }
    }

    // 刷新数据
    async function refreshData() {
      const page = document.querySelector('.nav-item.active').dataset.page;

      if (page === 'thirdparty') await refreshThirdParty();
      else if (page === 'crown') await refreshCrown();
      else if (page === 'dashboard') await loadDashboard();
    }

    async function refreshThirdParty() {
      try {
        const res = await fetch('/api/thirdparty/refresh', { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          alert('刷新成功');
          // 获取当前选中的状态
          const currentStatus = document.getElementById('filter-status').value;
          await loadThirdPartyData(currentStatus);
        }
      } catch (error) {
        alert('刷新失败: ' + error.message);
      }
    }

    async function refreshCrown() {
      alert('皇冠数据自动更新中...');
      // 获取当前选中的类型
      const currentType = document.getElementById('crown-filter-type').value;
      await loadCrownData(currentType);
    }

    // 工具函数
    function formatTime(time) {
      if (!time) return '-';
      const date = new Date(time);

      // 后端存储的是 UTC-4 时间，前端显示需要转换为 UTC-8（中国时间）
      // UTC-4 -> UTC-8 需要加 4 小时
      const utcTime = date.getTime();
      const utcMinus8 = new Date(utcTime + 4 * 60 * 60 * 1000);

      const month = String(utcMinus8.getUTCMonth() + 1).padStart(2, '0');
      const day = String(utcMinus8.getUTCDate()).padStart(2, '0');
      const hour = String(utcMinus8.getUTCHours()).padStart(2, '0');
      const minute = String(utcMinus8.getUTCMinutes()).padStart(2, '0');

      return `${month}-${day} ${hour}:${minute}`;
    }

    function getStatusText(status) {
      const map = {
        'live': '滚球',
        'today': '今日',
        'early': '早盘',
        'tomorrow': '明日'
      };
      return map[status] || status;
    }

    function viewMatchDetail(matchId) {
      alert('查看赛事详情: ' + matchId);
    }

    function viewCrownDetail(matchId) {
      alert('查看皇冠赛事详情: ' + matchId);
    }

    // 导出球队信息（用于翻译）- Excel 格式
    async function exportTeams() {
      try {
        // 直接下载 Excel 文件
        const excelRes = await fetch('/api/thirdparty/export-teams-excel');

        if (!excelRes.ok) {
          const errorData = await excelRes.json();
          alert('导出失败: ' + (errorData.error || '未知错误'));
          return;
        }

        const blob = await excelRes.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `teams-export-${new Date().toISOString().split('T')[0]}.xlsx`;
        link.click();
        URL.revokeObjectURL(url);

        alert('导出成功！请在 Excel 中填写 crown_cn 列后导入');
      } catch (error) {
        alert('导出失败: ' + error.message);
      }
    }

    // 导出联赛信息（用于翻译）- Excel 格式
    async function exportLeagues() {
      try {
        // 直接下载 Excel 文件
        const excelRes = await fetch('/api/thirdparty/export-leagues-excel');

        if (!excelRes.ok) {
          const errorData = await excelRes.json();
          alert('导出失败: ' + (errorData.error || '未知错误'));
          return;
        }

        const blob = await excelRes.blob();
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `leagues-export-${new Date().toISOString().split('T')[0]}.xlsx`;
        link.click();
        URL.revokeObjectURL(url);

        alert('导出成功！请在 Excel 中填写 crown_cn 列后导入');
      } catch (error) {
        alert('导出失败: ' + error.message);
      }
    }

    function exportData(type) {
      if (type === 'league-mapping') {
        const dataStr = JSON.stringify(leagueMappingData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `league-mapping-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
      } else if (type === 'mapping') {
        const dataStr = JSON.stringify(mappingData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `team-mapping-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
      } else {
        alert('导出 ' + type + ' 数据');
      }
    }

    function showStats() {
      alert('显示统计信息');
    }

    function updateStats() {
      loadDashboard();
    }

    // ==================== 赛事推送功能 ====================
    let currentMatchPushPage = 1;
    let matchPushPageSize = 50;
    let totalMatchPushPages = 1;
    let matchPushStats = {};

    // 加载赛事推送数据
    async function loadMatchPushData(page = 1) {
      try {
        const showType = document.getElementById('match-push-type').value;
        const params = new URLSearchParams({
          showType,
          page,
          pageSize: matchPushPageSize
        });

        const res = await fetch(`/api/match-push?${params}`);
        const data = await res.json();

        if (data.success) {
          matchPushData = data.data;
          matchPushStats = data.stats;
          currentMatchPushPage = data.pagination.page;
          totalMatchPushPages = data.pagination.totalPages;

          // 更新统计信息
          updateMatchPushStats();

          // 应用筛选
          filterMatchPush();

          // 更新分页
          updateMatchPushPagination();
        } else {
          alert('加载失败: ' + data.error);
        }
      } catch (error) {
        console.error('加载赛事推送数据失败:', error);
        alert('加载失败: ' + error.message);
      }
    }

    // 更新统计信息
    function updateMatchPushStats() {
      document.getElementById('stat-total').textContent = matchPushStats.total || 0;
      document.getElementById('stat-matched').textContent = matchPushStats.matched || 0;
      document.getElementById('stat-unmatched').textContent = matchPushStats.unmatched || 0;

      const rate = matchPushStats.total > 0
        ? ((matchPushStats.matched / matchPushStats.total) * 100).toFixed(1)
        : 0;
      document.getElementById('stat-rate').textContent = rate + '%';
    }

    // 筛选赛事
    function filterMatchPush() {
      const filter = document.getElementById('match-push-filter').value;

      if (filter === 'all') {
        filteredMatchPush = matchPushData;
      } else if (filter === 'matched') {
        filteredMatchPush = matchPushData.filter(m => m.matched);
      } else if (filter === 'unmatched') {
        filteredMatchPush = matchPushData.filter(m => !m.matched);
      }

      renderMatchPush();
    }

    // 渲染赛事列表
    function renderMatchPush() {
      const container = document.getElementById('match-push-container');

      if (filteredMatchPush.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <i class="ri-inbox-line" style="font-size: 48px; color: var(--text-muted); margin-bottom: 15px;"></i>
            <div style="color: var(--text-muted);">暂无数据</div>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredMatchPush.map(item => {
        const crown = item.crown;
        const isports = item.isports;
        const matched = item.matched;
        const timeDiff = item.timeDiff;
        const matchedBy = item.matchedBy;

        // 时间差提示
        let timeDiffText = '';
        if (matched && timeDiff !== undefined) {
          if (timeDiff < 1) {
            timeDiffText = '<span style="color: var(--success); font-size: 12px;">⏱ 时间完全一致</span>';
          } else if (timeDiff <= 5) {
            timeDiffText = `<span style="color: var(--success); font-size: 12px;">⏱ 时间差 ${timeDiff.toFixed(0)} 分钟</span>`;
          } else if (timeDiff <= 30) {
            timeDiffText = `<span style="color: var(--warning); font-size: 12px;">⏱ 时间差 ${timeDiff.toFixed(0)} 分钟</span>`;
          } else {
            timeDiffText = `<span style="color: var(--danger); font-size: 12px;">⏱ 时间差 ${timeDiff.toFixed(0)} 分钟</span>`;
          }
        }

        // 匹配方式提示
        let matchTypeText = '';
        if (matchedBy === 'both') {
          matchTypeText = '球队+联赛';
        } else if (matchedBy === 'team') {
          matchTypeText = '球队';
        } else if (matchedBy === 'league') {
          matchTypeText = '联赛';
        } else if (matchedBy === 'time') {
          matchTypeText = '时间';
        }

        return `
          <div class="match-card" style="margin-bottom: 15px; border-left: 3px solid ${matched ? 'var(--success)' : 'var(--warning)'};">
            <div class="match-header">
              <div class="team-home">${crown.home_zh}</div>
              <div class="match-info">
                <div>${crown.league_zh} <span class="badge badge-${crown.showType}">${getShowTypeText(crown.showType)}</span></div>
                <div class="match-time">${formatTime(crown.match_time)}</div>
                ${matched ? `<span class="badge badge-success" style="margin-top: 5px;">已匹配 (${matchTypeText})</span>` : '<span class="badge badge-warning" style="margin-top: 5px;">未匹配</span>'}
                ${timeDiffText ? `<div style="margin-top: 3px;">${timeDiffText}</div>` : ''}
              </div>
              <div class="team-away">${crown.away_zh}</div>
            </div>

            <!-- 皇冠赔率 -->
            <div style="margin-top: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
              <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                <i class="ri-trophy-line"></i> 皇冠赔率
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div>
                  <div style="color: var(--text-muted); font-size: 12px;">让球</div>
                  <div>${crown.markets?.handicap?.handicap || '-'} (${crown.markets?.handicap?.home || '-'} / ${crown.markets?.handicap?.away || '-'})</div>
                </div>
                <div>
                  <div style="color: var(--text-muted); font-size: 12px;">大小球</div>
                  <div>${crown.markets?.overUnder?.line || '-'} (${crown.markets?.overUnder?.over || '-'} / ${crown.markets?.overUnder?.under || '-'})</div>
                </div>
                <div>
                  <div style="color: var(--text-muted); font-size: 12px;">独赢</div>
                  <div>${crown.markets?.moneyline?.home || '-'} / ${crown.markets?.moneyline?.draw || '-'} / ${crown.markets?.moneyline?.away || '-'}</div>
                </div>
              </div>
            </div>

            ${matched && isports ? `
              <!-- iSports 赔率 -->
              <div style="margin-top: 10px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                <div style="font-weight: bold; margin-bottom: 5px; color: var(--success);">
                  <i class="ri-database-2-line"></i> iSports 赔率
                </div>
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">
                  比赛时间: ${formatTime(isports.match_time)}
                </div>

                <!-- 球队和联赛信息 -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
                  <div>
                    <div style="color: var(--text-muted); font-size: 12px;">联赛</div>
                    <div style="font-size: 13px;">${isports.league_name_cn || isports.league_name_en}</div>
                    ${isports.league_name_tc ? `<div style="font-size: 11px; color: var(--text-muted);">繁体: ${isports.league_name_tc}</div>` : ''}
                  </div>
                  <div>
                    <div style="color: var(--text-muted); font-size: 12px;">主队</div>
                    <div style="font-size: 13px;">${isports.team_home_cn || isports.team_home_en}</div>
                    ${isports.team_home_tc ? `<div style="font-size: 11px; color: var(--text-muted);">繁体: ${isports.team_home_tc}</div>` : ''}
                  </div>
                  <div>
                    <div style="color: var(--text-muted); font-size: 12px;">客队</div>
                    <div style="font-size: 13px;">${isports.team_away_cn || isports.team_away_en}</div>
                    ${isports.team_away_tc ? `<div style="font-size: 11px; color: var(--text-muted);">繁体: ${isports.team_away_tc}</div>` : ''}
                  </div>
                </div>

                <!-- 赔率信息 -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                  <div>
                    <div style="color: var(--text-muted); font-size: 12px;">让球</div>
                    <div>${isports.odds?.handicap?.[0]?.handicap_line || '-'} (${isports.odds?.handicap?.[0]?.home_odds || '-'} / ${isports.odds?.handicap?.[0]?.away_odds || '-'})</div>
                  </div>
                  <div>
                    <div style="color: var(--text-muted); font-size: 12px;">大小球</div>
                    <div>${isports.odds?.totals?.[0]?.total_line || '-'} (${isports.odds?.totals?.[0]?.over_odds || '-'} / ${isports.odds?.totals?.[0]?.under_odds || '-'})</div>
                  </div>
                  <div>
                    <div style="color: var(--text-muted); font-size: 12px;">独赢</div>
                    <div>${isports.odds?.moneyline?.home_odds || '-'} / ${isports.odds?.moneyline?.draw_odds || '-'} / ${isports.odds?.moneyline?.away_odds || '-'}</div>
                  </div>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // 获取赛事类型文本
    function getShowTypeText(showType) {
      const map = { 'live': '滚球', 'today': '今日', 'early': '早盘' };
      return map[showType] || showType;
    }

    // 分页相关
    function changeMatchPushPageSize() {
      matchPushPageSize = parseInt(document.getElementById('match-push-page-size').value);
      loadMatchPushData(1);
    }

    function goToMatchPushPage(page) {
      if (page < 1 || page > totalMatchPushPages) return;
      loadMatchPushData(page);
    }

    function updateMatchPushPagination() {
      const pagination = document.getElementById('match-push-pagination');
      const pageInfo = document.getElementById('match-push-page-info');
      const totalCount = document.getElementById('match-push-total-count');
      const firstBtn = document.getElementById('match-push-first-page');
      const prevBtn = document.getElementById('match-push-prev-page');
      const nextBtn = document.getElementById('match-push-next-page');
      const lastBtn = document.getElementById('match-push-last-page');

      if (totalMatchPushPages > 1) {
        pagination.style.display = 'flex';
        pageInfo.textContent = `第 ${currentMatchPushPage} 页 / 共 ${totalMatchPushPages} 页`;
        totalCount.textContent = matchPushStats.total || 0;

        firstBtn.disabled = currentMatchPushPage === 1;
        prevBtn.disabled = currentMatchPushPage === 1;
        nextBtn.disabled = currentMatchPushPage === totalMatchPushPages;
        lastBtn.disabled = currentMatchPushPage === totalMatchPushPages;
      } else {
        pagination.style.display = 'none';
      }
    }

    // ==================== 赛事匹配功能 ====================
    let matchCompareData = [];
    let filteredCompareData = [];

    // 加载赛事匹配数据
    async function loadMatchCompareData() {
      try {
        const showType = document.getElementById('compare-type').value;
        const timeRange = document.getElementById('compare-time-range').value;

        const params = new URLSearchParams({
          showType,
          timeRange
        });

        const res = await fetch(`/api/match-compare?${params}`);
        const data = await res.json();

        if (data.success) {
          matchCompareData = data.data;
          filteredCompareData = matchCompareData;
          updateMatchCompareStats(data.stats);
          renderMatchCompare();
        } else {
          alert('加载失败: ' + data.error);
        }
      } catch (error) {
        console.error('加载赛事匹配数据失败:', error);
        alert('加载失败: ' + error.message);
      }
    }

    // 更新统计信息
    function updateMatchCompareStats(stats) {
      document.getElementById('compare-crown-count').textContent = stats.crownCount || 0;
      document.getElementById('compare-isports-count').textContent = stats.isportsCount || 0;
      document.getElementById('compare-ai-matched').textContent = stats.aiMatched || 0;
      document.getElementById('compare-manual-matched').textContent = stats.manualMatched || 0;
      document.getElementById('compare-unmatched').textContent = stats.unmatched || 0;
    }

    // 渲染赛事对比列表
    function renderMatchCompare() {
      const container = document.getElementById('match-compare-container');

      if (filteredCompareData.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">暂无数据</div>';
        return;
      }

      // 按时间排序
      const sorted = [...filteredCompareData].sort((a, b) => {
        const timeA = new Date(a.crown?.match_time || a.isports?.match_time || 0);
        const timeB = new Date(b.crown?.match_time || b.isports?.match_time || 0);
        return timeA - timeB;
      });

      let html = '';
      sorted.forEach(item => {
        html += renderCompareItem(item);
      });

      container.innerHTML = html;
    }

    // 渲染单个对比项
    function renderCompareItem(item) {
      const { crown, isports, matchType, confidence, timeDiff } = item;

      const matchStatusBadge = matchType === 'ai'
        ? `<span class="badge badge-success">AI 匹配 (${Math.round(confidence * 100)}%)</span>`
        : matchType === 'manual'
        ? '<span class="badge badge-primary">手动匹配</span>'
        : '<span class="badge badge-warning">未匹配</span>';

      const timeDiffText = timeDiff !== undefined
        ? `<span style="font-size: 12px; color: var(--text-muted);">时间差: ${timeDiff} 分钟</span>`
        : '';

      return `
        <div class="compare-item" style="margin-bottom: 20px; padding: 20px; background: var(--bg-light); border-radius: 12px; border: 1px solid var(--border);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
              ${matchStatusBadge}
              ${timeDiffText}
            </div>
            <div>
              ${matchType === 'none' ? `
                <button class="btn btn-sm btn-primary" onclick="manualMatch('${crown?.gid}', '${isports?.match_id}')">
                  <i class="ri-link"></i> 手动匹配
                </button>
              ` : `
                <button class="btn btn-sm btn-danger" onclick="unmatch('${crown?.gid}', '${isports?.match_id}')">
                  <i class="ri-link-unlink"></i> 取消匹配
                </button>
              `}
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- 皇冠赛事 -->
            <div style="padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
              <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">
                <i class="ri-trophy-line"></i> 皇冠
              </div>
              ${crown ? `
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 14px; color: var(--text-muted);">联赛</div>
                  <div style="font-weight: 500;">${crown.league_zh}</div>
                </div>
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 14px; color: var(--text-muted);">主队</div>
                  <div style="font-weight: 500;">${crown.home_zh}</div>
                </div>
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 14px; color: var(--text-muted);">客队</div>
                  <div style="font-weight: 500;">${crown.away_zh}</div>
                </div>
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 14px; color: var(--text-muted);">时间</div>
                  <div style="font-weight: 500;">${formatTime(crown.match_time)}</div>
                </div>
                <div>
                  <div style="font-size: 14px; color: var(--text-muted);">GID</div>
                  <div style="font-size: 12px; font-family: monospace;">${crown.gid}</div>
                </div>
              ` : '<div style="color: var(--text-muted); text-align: center; padding: 20px;">无数据</div>'}
            </div>

            <!-- iSports 赛事 -->
            <div style="padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
              <div style="font-weight: bold; margin-bottom: 10px; color: var(--secondary);">
                <i class="ri-database-2-line"></i> iSports
              </div>
              ${isports ? `
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 14px; color: var(--text-muted);">联赛</div>
                  <div style="font-weight: 500;">${isports.league_name_cn || isports.league_name_en}</div>
                  ${isports.league_name_tc ? `<div style="font-size: 12px; color: var(--text-muted);">繁体: ${isports.league_name_tc}</div>` : ''}
                </div>
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 14px; color: var(--text-muted);">主队</div>
                  <div style="font-weight: 500;">${isports.team_home_cn || isports.team_home_en}</div>
                  ${isports.team_home_tc ? `<div style="font-size: 12px; color: var(--text-muted);">繁体: ${isports.team_home_tc}</div>` : ''}
                </div>
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 14px; color: var(--text-muted);">客队</div>
                  <div style="font-weight: 500;">${isports.team_away_cn || isports.team_away_en}</div>
                  ${isports.team_away_tc ? `<div style="font-size: 12px; color: var(--text-muted);">繁体: ${isports.team_away_tc}</div>` : ''}
                </div>
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 14px; color: var(--text-muted);">时间</div>
                  <div style="font-weight: 500;">${formatTime(isports.match_time)}</div>
                </div>
                <div>
                  <div style="font-size: 14px; color: var(--text-muted);">Match ID</div>
                  <div style="font-size: 12px; font-family: monospace;">${isports.match_id}</div>
                </div>
              ` : '<div style="color: var(--text-muted); text-align: center; padding: 20px;">无数据</div>'}
            </div>
          </div>
        </div>
      `;
    }

    // 筛选赛事对比数据
    function filterMatchCompare() {
      const filterType = document.getElementById('compare-filter').value;
      const leagueFilter = document.getElementById('compare-league-filter').value.toLowerCase();

      filteredCompareData = matchCompareData.filter(item => {
        // 匹配状态筛选
        if (filterType === 'ai-matched' && item.matchType !== 'ai') return false;
        if (filterType === 'manual-matched' && item.matchType !== 'manual') return false;
        if (filterType === 'unmatched' && item.matchType !== 'none') return false;

        // 联赛筛选
        if (leagueFilter) {
          const crownLeague = (item.crown?.league_zh || '').toLowerCase();
          const isportsLeague = (item.isports?.league_name_cn || item.isports?.league_name_en || '').toLowerCase();
          if (!crownLeague.includes(leagueFilter) && !isportsLeague.includes(leagueFilter)) {
            return false;
          }
        }

        return true;
      });

      renderMatchCompare();
    }

    // 手动匹配
    async function manualMatch(crownGid, isportsMatchId) {
      if (!confirm('确定要手动匹配这两场赛事吗？')) return;

      try {
        const res = await fetch('/api/match-compare/manual-match', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ crownGid, isportsMatchId })
        });

        const data = await res.json();
        if (data.success) {
          alert('匹配成功！');
          loadMatchCompareData();
        } else {
          alert('匹配失败: ' + data.error);
        }
      } catch (error) {
        console.error('手动匹配失败:', error);
        alert('匹配失败: ' + error.message);
      }
    }

    // 取消匹配
    async function unmatch(crownGid, isportsMatchId) {
      if (!confirm('确定要取消匹配吗？')) return;

      try {
        const res = await fetch('/api/match-compare/unmatch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ crownGid, isportsMatchId })
        });

        const data = await res.json();
        if (data.success) {
          alert('已取消匹配！');
          loadMatchCompareData();
        } else {
          alert('取消失败: ' + data.error);
        }
      } catch (error) {
        console.error('取消匹配失败:', error);
        alert('取消失败: ' + error.message);
      }
    }

    // 导出 Excel
    async function exportMatchCompare() {
      try {
        const showType = document.getElementById('compare-type').value;
        const timeRange = document.getElementById('compare-time-range').value;

        const params = new URLSearchParams({
          showType,
          timeRange
        });

        window.location.href = `/api/match-compare/export?${params}`;
      } catch (error) {
        console.error('导出失败:', error);
        alert('导出失败: ' + error.message);
      }
    }

    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

